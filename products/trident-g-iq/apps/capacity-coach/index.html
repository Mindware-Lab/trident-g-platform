<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacity Training Coach</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

<script type="text/babel" data-presets="env,react">
  const { useMemo, useState } = React;

  const STORAGE = {
    PROGRESS: 'iqmw.progress.v1',
    PROGRESS_LEGACY: 'trainingProgress',
    CAPACITY_LAST_GAME: 'iqmw.capacity.lastGameSelection',
    CAPACITY_LAST_SESSION: 'iqmw.capacity.lastSession'
  };

  const PROGRAM_TARGET = 24;

  const GAMES = [
    { id: 'classic', label: 'Classic dual n-back', url: '../n-back-games/index.html?game=classic', note: 'Default baseline for Type-1 stability.' },
    { id: 'transitive', label: 'Transitive n-back', url: '../n-back-games/index.html?game=transitive', note: 'Relational binding and ordered comparisons.' },
    { id: 'graph', label: 'Graph / edge n-back', url: '../n-back-games/index.html?game=graph', note: 'Map-like relation tracking under load.' },
    { id: 'propositional', label: 'Propositional n-back', url: '../n-back-games/index.html?game=propositional', note: 'Rule discipline and logical updating.' }
  ];

  const safeParse = (raw, fallback) => {
    try { return JSON.parse(raw); } catch { return fallback; }
  };

  const loadProgress = () => {
    const fromNew = safeParse(localStorage.getItem(STORAGE.PROGRESS), null);
    const fromLegacy = safeParse(localStorage.getItem(STORAGE.PROGRESS_LEGACY), null);
    const raw = fromNew || fromLegacy || {};

    const completed = Number(raw.totalSessionsCompleted)
      || Number(raw.anchorSessionsCompleted) + Number(raw.swapSessionsCompleted)
      || 0;

    return {
      schemaVersion: 'progress_v1',
      totalSessionsCompleted: completed,
      totalSessionsTarget: PROGRAM_TARGET,
      lastSessionDate: raw.lastSessionDate || null,
      programStartDate: raw.programStartDate || new Date().toISOString(),
      programCompleted: completed >= PROGRAM_TARGET,
      programCompletionDate: raw.programCompletionDate || null
    };
  };

  const saveProgress = (next) => {
    const json = JSON.stringify(next);
    localStorage.setItem(STORAGE.PROGRESS, json);
    localStorage.setItem(STORAGE.PROGRESS_LEGACY, json);
  };

  function App() {
    const [screen, setScreen] = useState('home');
    const [progress, setProgress] = useState(() => loadProgress());
    const [zoneMode, setZoneMode] = useState('in_band');
    const [planType, setPlanType] = useState('type1_build');
    const [selectedGame, setSelectedGame] = useState('classic');
    const [speedPreset, setSpeedPreset] = useState('calm');
    const [interferencePreset, setInterferencePreset] = useState('low');
    const [bridgeObs, setBridgeObs] = useState('');
    const [bridgeMove, setBridgeMove] = useState('');

    const selectedGameObj = useMemo(
      () => GAMES.find((g) => g.id === selectedGame) || GAMES[0],
      [selectedGame]
    );

    const sessionsRemaining = Math.max(0, PROGRAM_TARGET - (progress.totalSessionsCompleted || 0));

    const computePlanType = (zone) => {
      if (zone !== 'in_band') return 'type1_light';
      return 'type1_build';
    };

    const planLabel = {
      type1_light: 'Type-1 light session',
      type1_build: 'Type-1 build session'
    }[planType] || 'Type-1 session';

    const completeSession = () => {
      const nextCompleted = Math.min(PROGRAM_TARGET, (progress.totalSessionsCompleted || 0) + 1);
      const nowIso = new Date().toISOString();
      const next = {
        ...progress,
        totalSessionsCompleted: nextCompleted,
        totalSessionsTarget: PROGRAM_TARGET,
        lastSessionDate: nowIso,
        programCompleted: nextCompleted >= PROGRAM_TARGET,
        programCompletionDate: nextCompleted >= PROGRAM_TARGET ? nowIso : progress.programCompletionDate
      };
      saveProgress(next);
      setProgress(next);

      const handoff = {
        localDate: nowIso.slice(0, 10),
        timestamp: Date.now(),
        planType,
        gameId: selectedGame,
        zoneMode,
        settings: {
          speedPreset,
          interferencePreset
        },
        bridge: {
          observation: bridgeObs.trim(),
          move: bridgeMove.trim()
        }
      };
      localStorage.setItem(STORAGE.CAPACITY_LAST_SESSION, JSON.stringify(handoff));
      localStorage.setItem(STORAGE.CAPACITY_LAST_GAME, JSON.stringify(handoff));

      setScreen('home');
      setBridgeObs('');
      setBridgeMove('');
    };

    if (screen === 'results') {
      const bridgeReady = bridgeObs.trim() && bridgeMove.trim();
      return (
        <div className="min-h-screen bg-neutral-200 p-4 md:p-8">
          <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h1 className="text-3xl font-bold mb-2 text-neutral-800">Session wrap-up</h1>
            <p className="text-neutral-600 mb-6">Lock in one observation and one next-use move, then count this session.</p>

            <div className="p-4 rounded-lg border-2 border-blue-200 bg-blue-50 mb-6">
              <p className="font-semibold text-neutral-800">Played: <span className="text-blue-700">{selectedGameObj.label}</span></p>
              <p className="text-sm text-neutral-600">Plan: {planLabel} | Speed: {speedPreset} | Interference: {interferencePreset}</p>
            </div>

            <label className="block text-sm font-semibold mb-2 text-neutral-800">In the game it looked like...</label>
            <input
              type="text"
              value={bridgeObs}
              onChange={(e) => setBridgeObs(e.target.value)}
              className="w-full p-3 rounded border-2 border-neutral-300 mb-4"
              placeholder="One concise observation"
            />

            <label className="block text-sm font-semibold mb-2 text-neutral-800">In the next task I will use it by...</label>
            <input
              type="text"
              value={bridgeMove}
              onChange={(e) => setBridgeMove(e.target.value)}
              className="w-full p-3 rounded border-2 border-neutral-300 mb-6"
              placeholder="One concrete transfer move"
            />

            <button
              onClick={completeSession}
              disabled={!bridgeReady}
              className="w-full py-3 px-6 rounded-lg font-semibold"
              style={{
                backgroundColor: bridgeReady ? '#2764B7' : '#E0E0E0',
                color: bridgeReady ? '#FFFFFF' : '#6D6D6D'
              }}
            >
              Complete session ({Math.min(PROGRAM_TARGET, progress.totalSessionsCompleted + 1)}/{PROGRAM_TARGET})
            </button>
          </div>
        </div>
      );
    }

    return (
      <div className="min-h-screen bg-neutral-200 p-4 md:p-8">
        <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-6 md:p-8">
          <h1 className="text-3xl font-bold mb-2 text-neutral-800">Capacity Training Coach</h1>
          <p className="text-neutral-600 mb-6">Type-1 transfer mode: build runtime stability across any of the four n-back games.</p>

          <div className="p-4 rounded-lg border-2 border-blue-200 bg-blue-50 mb-6">
            <p className="font-semibold text-neutral-800">Program progress: {progress.totalSessionsCompleted}/{PROGRAM_TARGET} sessions</p>
            <p className="text-sm text-neutral-600">Remaining: {sessionsRemaining}</p>
          </div>

          <div className="mb-6">
            <p className="font-semibold mb-3 text-neutral-800">State gate</p>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
              {[
                { id: 'in_band', label: 'In-band (Full)' },
                { id: 'light', label: 'Light' },
                { id: 'reset', label: 'Reset' }
              ].map((z) => (
                <button
                  key={z.id}
                  onClick={() => {
                    setZoneMode(z.id);
                    setPlanType(computePlanType(z.id));
                  }}
                  className="p-3 rounded-lg border-2 text-left"
                  style={{
                    borderColor: zoneMode === z.id ? '#2764B7' : '#E0E0E0',
                    backgroundColor: zoneMode === z.id ? '#E8F4FF' : '#FFFFFF'
                  }}
                >
                  {z.label}
                </button>
              ))}
            </div>
          </div>

          <div className="mb-6">
            <p className="font-semibold mb-3 text-neutral-800">Preset controls</p>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <select className="p-3 rounded border-2 border-neutral-300" value={speedPreset} onChange={(e) => setSpeedPreset(e.target.value)}>
                <option value="calm">Speed: Calm</option>
                <option value="fast">Speed: Fast</option>
              </select>
              <select className="p-3 rounded border-2 border-neutral-300" value={interferencePreset} onChange={(e) => setInterferencePreset(e.target.value)}>
                <option value="low">Interference: Low</option>
                <option value="high">Interference: High</option>
              </select>
            </div>
          </div>

          <div className="mb-6">
            <p className="font-semibold mb-3 text-neutral-800">Choose today’s game (all allowed)</p>
            <div className="space-y-2">
              {GAMES.map((g) => (
                <button
                  key={g.id}
                  onClick={() => setSelectedGame(g.id)}
                  className="w-full p-3 rounded-lg border-2 text-left"
                  style={{
                    borderColor: selectedGame === g.id ? '#2764B7' : '#E0E0E0',
                    backgroundColor: selectedGame === g.id ? '#E8F4FF' : '#FFFFFF'
                  }}
                >
                  <div className="font-semibold text-neutral-800">{g.label}{g.id === 'classic' ? ' (Suggested start)' : ''}</div>
                  <div className="text-sm text-neutral-600">{g.note}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="p-4 rounded-lg bg-neutral-100 mb-6">
            <p className="text-neutral-800 font-semibold">Today’s plan: {planLabel}</p>
            <p className="text-sm text-neutral-600">No anchor game and no wheel progression. You can choose any of the four games each session.</p>
          </div>

          <button
            onClick={() => {
              window.open(selectedGameObj.url, '_blank', 'noopener,noreferrer');
              setScreen('results');
            }}
            className="w-full py-3 px-6 rounded-lg font-semibold mb-3"
            style={{ backgroundColor: '#2764B7', color: '#FFFFFF' }}
          >
            Open {selectedGameObj.label}
          </button>

          <button
            onClick={() => setScreen('results')}
            className="w-full py-3 px-6 rounded-lg font-semibold border-2"
            style={{ borderColor: '#2764B7', color: '#2764B7', backgroundColor: '#FFFFFF' }}
          >
            I finished the game
          </button>
        </div>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>
