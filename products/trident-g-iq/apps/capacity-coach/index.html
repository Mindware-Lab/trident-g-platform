<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacity Training Coach</title>
  <link rel="stylesheet" href="../../../../branding/brand.css">
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

<script type="text/babel" data-presets="env,react">
  const { useEffect, useMemo, useState } = React;

  const STORAGE = {
    PROGRESS: 'iqmw.progress.v1',
    PROGRESS_LEGACY: 'trainingProgress',
    CAPACITY_LAST_GAME: 'iqmw.capacity.lastGameSelection',
    CAPACITY_LAST_SESSION: 'iqmw.capacity.lastSession'
  };

  const PROGRAM_TARGET = 24;

  const GAMES = [
    { id: 'classic', label: 'Classic n-back', note: 'Default start for Type-1 stability.' },
    { id: 'emotional', label: 'Emotional n-back', note: 'Add salience control under load.' },
    { id: 'non_categorical', label: 'Non-categorical n-back', note: 'Train broad runtime control.' },
    { id: 'logic_gated', label: 'Logic-gated n-back', note: 'Rule discipline and clean updating.' }
  ];

  const BREATH_ROUTINES = {
    upshift: {
      name: 'Upshift',
      description: 'Inhale-led breathing to raise engagement.',
      cue: 'Inhale 3s, exhale 2s.'
    },
    amplify: {
      name: 'Amplify',
      description: 'Slow-paced breathing to stabilise.',
      cue: 'Inhale 4s, exhale 6s.'
    },
    downshift: {
      name: 'Downshift',
      description: 'Cyclic sighing to reduce overload.',
      cue: 'Two short inhales, one long sigh out.'
    }
  };

  const safeParse = (raw, fallback) => {
    try { return JSON.parse(raw); } catch { return fallback; }
  };

  const loadProgress = () => {
    const fromNew = safeParse(localStorage.getItem(STORAGE.PROGRESS), null);
    const fromLegacy = safeParse(localStorage.getItem(STORAGE.PROGRESS_LEGACY), null);
    const raw = fromNew || fromLegacy || {};

    const completed = Number(raw.totalSessionsCompleted)
      || Number(raw.anchorSessionsCompleted) + Number(raw.swapSessionsCompleted)
      || 0;

    return {
      schemaVersion: 'progress_v1',
      totalSessionsCompleted: completed,
      totalSessionsTarget: PROGRAM_TARGET,
      lastSessionDate: raw.lastSessionDate || null,
      programStartDate: raw.programStartDate || new Date().toISOString(),
      programCompleted: completed >= PROGRAM_TARGET,
      programCompletionDate: raw.programCompletionDate || null
    };
  };

  const saveProgress = (next) => {
    const json = JSON.stringify(next);
    localStorage.setItem(STORAGE.PROGRESS, json);
    localStorage.setItem(STORAGE.PROGRESS_LEGACY, json);
  };

  function App() {
    const [screen, setScreen] = useState('home');
    const [progress, setProgress] = useState(() => loadProgress());
    const [zoneMode, setZoneMode] = useState('in_band');
    const [planType, setPlanType] = useState('type1_build');
    const [stateRatings, setStateRatings] = useState({ load: 4, drift: 4, mismatch: 4 });
    const [lastStateReason, setLastStateReason] = useState('');
    const [selectedGame, setSelectedGame] = useState('classic');
    const [speedPreset, setSpeedPreset] = useState('calm');
    const [interferencePreset, setInterferencePreset] = useState('low');
    const [bridgeObs, setBridgeObs] = useState('');
    const [bridgeMove, setBridgeMove] = useState('');
    const [breathRoutine, setBreathRoutine] = useState('amplify');
    const [breathRunning, setBreathRunning] = useState(false);
    const [breathRemaining, setBreathRemaining] = useState(0);

    const selectedGameObj = useMemo(
      () => GAMES.find((g) => g.id === selectedGame) || GAMES[0],
      [selectedGame]
    );

    const sessionsRemaining = Math.max(0, PROGRAM_TARGET - (progress.totalSessionsCompleted || 0));

    const computePlanType = (zone) => {
      if (zone !== 'in_band') return 'type1_light';
      return 'type1_build';
    };

    const estimateZoneFromRatings = () => {
      const vals = [stateRatings.load, stateRatings.drift, stateRatings.mismatch];
      const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
      const peak = Math.max(...vals);
      let nextZone = 'in_band';
      let reason = 'Low volatility and manageable load.';
      if (peak >= 8 || avg >= 7) {
        nextZone = 'reset';
        reason = 'High strain detected. Downshift before hard training.';
      } else if (avg >= 5) {
        nextZone = 'light';
        reason = 'Moderate instability. Keep session light and clean.';
      }
      setZoneMode(nextZone);
      setPlanType(computePlanType(nextZone));
      setLastStateReason(reason);
      if (nextZone === 'reset') setBreathRoutine('downshift');
      else if (nextZone === 'light') setBreathRoutine('amplify');
      else setBreathRoutine('upshift');
    };

    useEffect(() => {
      if (!breathRunning || breathRemaining <= 0) return;
      const id = setInterval(() => setBreathRemaining((s) => s - 1), 1000);
      return () => clearInterval(id);
    }, [breathRunning, breathRemaining]);

    useEffect(() => {
      if (breathRunning && breathRemaining <= 0) setBreathRunning(false);
    }, [breathRunning, breathRemaining]);

    const planLabel = {
      type1_light: 'Type-1 light session',
      type1_build: 'Type-1 build session'
    }[planType] || 'Type-1 session';

    const launchExternalGame = () => {
      const handoff = {
        localDate: new Date().toISOString().slice(0, 10),
        timestamp: Date.now(),
        gameId: selectedGame,
        gameLabel: selectedGameObj.label,
        planType,
        zoneMode,
        settings: {
          speedPreset,
          interferencePreset
        },
        breathing: {
          routineId: breathRoutine,
          routineName: BREATH_ROUTINES[breathRoutine].name
        }
      };
      localStorage.setItem(STORAGE.CAPACITY_LAST_GAME, JSON.stringify(handoff));
      alert('Launch i3 Mindware (Adobe AIR), choose "' + selectedGameObj.label + '", run your block(s), then return here.');
      setScreen('results');
    };

    const completeSession = () => {
      const nextCompleted = Math.min(PROGRAM_TARGET, (progress.totalSessionsCompleted || 0) + 1);
      const nowIso = new Date().toISOString();
      const next = {
        ...progress,
        totalSessionsCompleted: nextCompleted,
        totalSessionsTarget: PROGRAM_TARGET,
        lastSessionDate: nowIso,
        programCompleted: nextCompleted >= PROGRAM_TARGET,
        programCompletionDate: nextCompleted >= PROGRAM_TARGET ? nowIso : progress.programCompletionDate
      };
      saveProgress(next);
      setProgress(next);

      const handoff = {
        localDate: nowIso.slice(0, 10),
        timestamp: Date.now(),
        planType,
        gameId: selectedGame,
        gameLabel: selectedGameObj.label,
        zoneMode,
        settings: {
          speedPreset,
          interferencePreset
        },
        breathing: {
          routineId: breathRoutine,
          routineName: BREATH_ROUTINES[breathRoutine].name
        },
        bridge: {
          observation: bridgeObs.trim(),
          move: bridgeMove.trim()
        }
      };
      localStorage.setItem(STORAGE.CAPACITY_LAST_SESSION, JSON.stringify(handoff));
      localStorage.setItem(STORAGE.CAPACITY_LAST_GAME, JSON.stringify(handoff));

      setScreen('home');
      setBridgeObs('');
      setBridgeMove('');
    };

    if (screen === 'results') {
      const bridgeReady = bridgeObs.trim() && bridgeMove.trim();
      return (
        <div className="screen">
          <div className="topbar">
            <div className="brandleft">
              <div className="icon"><span className="iconText">T</span></div>
              <div>
                <p className="title">Capacity Training Coach</p>
                <p className="subtitle">Type-1 transfer session</p>
              </div>
            </div>
            <span className="chip">{progress.totalSessionsCompleted}/{PROGRAM_TARGET}</span>
          </div>

          <main className="content">
            <section className="card">
              <h1 className="h1">Session Wrap-Up</h1>
              <p className="p">Played: {selectedGameObj.label} | Plan: {planLabel}</p>
            </section>

            <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
              <label style={{ display: 'block', fontWeight: 900, marginBottom: '8px' }}>In the game it looked like...</label>
              <input
                type="text"
                value={bridgeObs}
                onChange={(e) => setBridgeObs(e.target.value)}
                placeholder="One concise observation"
                style={{ width: '100%', padding: '12px', borderRadius: '12px', border: '1px solid #E0E0E0', marginBottom: '12px' }}
              />

              <label style={{ display: 'block', fontWeight: 900, marginBottom: '8px' }}>In the next task I will use it by...</label>
              <input
                type="text"
                value={bridgeMove}
                onChange={(e) => setBridgeMove(e.target.value)}
                placeholder="One concrete transfer move"
                style={{ width: '100%', padding: '12px', borderRadius: '12px', border: '1px solid #E0E0E0' }}
              />

              <div className="btnRow">
                <button className="btn btnPrimary" onClick={completeSession} disabled={!bridgeReady}>
                  Complete session ({Math.min(PROGRAM_TARGET, progress.totalSessionsCompleted + 1)}/{PROGRAM_TARGET})
                </button>
                <button className="btn btnSecondary" onClick={() => setScreen('home')}>Back</button>
              </div>
            </section>
          </main>
        </div>
      );
    }

    return (
      <div className="screen">
        <div className="topbar">
          <div className="brandleft">
            <div className="icon"><span className="iconText">T</span></div>
            <div>
              <p className="title">Capacity Training Coach</p>
              <p className="subtitle">i3 Mindware session coordinator</p>
            </div>
          </div>
          <span className="chip">{progress.totalSessionsCompleted}/{PROGRAM_TARGET}</span>
        </div>

        <main className="content">
          <section className="card">
            <h1 className="h1">Type-1 Program</h1>
            <p className="p">24 sessions total. No anchor wheel. Choose any of the 4 n-back variants each session.</p>
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: 0, fontWeight: 900 }}>Progress</p>
            <p style={{ marginTop: '8px' }}>{progress.totalSessionsCompleted}/{PROGRAM_TARGET} complete | {sessionsRemaining} remaining</p>
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: '0 0 12px 0', fontWeight: 900 }}>State gate</p>
            <p style={{ margin: '0 0 10px 0', fontSize: '13px', color: '#333333' }}>
              Estimate state from quick ratings, then optionally override manually.
            </p>
            {[
              ['load', 'Load'],
              ['drift', 'Drift'],
              ['mismatch', 'Mismatch']
            ].map(([k, label]) => (
              <div key={k} style={{ marginBottom: '10px' }}>
                <label style={{ fontWeight: 700 }}>{label}: {stateRatings[k]}</label>
                <input
                  type="range"
                  min="0"
                  max="10"
                  value={stateRatings[k]}
                  onChange={(e) => setStateRatings((prev) => ({ ...prev, [k]: Number(e.target.value) }))}
                  style={{ width: '100%' }}
                />
              </div>
            ))}
            <div className="btnRow" style={{ marginTop: 8 }}>
              <button className="btn" style={{ background: '#FFFFFF', border: '1px solid #2764B7', color: '#2764B7' }} onClick={estimateZoneFromRatings}>
                Estimate state
              </button>
            </div>
            {lastStateReason ? (
              <p style={{ margin: '8px 0 0 0', fontSize: '13px', color: '#333333' }}>
                {lastStateReason}
              </p>
            ) : null}
            <div className="btnRow">
              {[
                { id: 'in_band', label: 'In-band (Full)' },
                { id: 'light', label: 'Light' },
                { id: 'reset', label: 'Reset' }
              ].map((z) => (
                <button
                  key={z.id}
                  className="btn"
                  onClick={() => {
                    setZoneMode(z.id);
                    setPlanType(computePlanType(z.id));
                  }}
                  style={{
                    background: zoneMode === z.id ? '#E8F4FF' : '#FFFFFF',
                    border: '1px solid ' + (zoneMode === z.id ? '#2764B7' : '#E0E0E0'),
                    color: '#111111'
                  }}
                >
                  {z.label}
                </button>
              ))}
            </div>
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: '0 0 12px 0', fontWeight: 900 }}>Optional breathing reset</p>
            <p style={{ margin: '0 0 10px 0', fontSize: '13px', color: '#333333' }}>
              Simplified from Zone Coach (no HR capture).
            </p>
            <select
              value={breathRoutine}
              onChange={(e) => setBreathRoutine(e.target.value)}
              style={{ padding: '10px', borderRadius: '12px', border: '1px solid #E0E0E0', marginBottom: '10px' }}
            >
              <option value="upshift">Upshift</option>
              <option value="amplify">Amplify</option>
              <option value="downshift">Downshift</option>
            </select>
            <p style={{ margin: '0 0 4px 0', fontWeight: 700 }}>{BREATH_ROUTINES[breathRoutine].name}</p>
            <p style={{ margin: '0 0 4px 0', fontSize: '13px' }}>{BREATH_ROUTINES[breathRoutine].description}</p>
            <p style={{ margin: 0, fontSize: '13px', color: '#555555' }}>{BREATH_ROUTINES[breathRoutine].cue}</p>
            <div className="btnRow">
              <button
                className="btn"
                style={{ background: '#FFFFFF', border: '1px solid #2764B7', color: '#2764B7' }}
                onClick={() => {
                  setBreathRemaining(90);
                  setBreathRunning(true);
                }}
              >
                Start 90s routine
              </button>
              {breathRunning ? (
                <button
                  className="btn"
                  style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', color: '#333333' }}
                  onClick={() => {
                    setBreathRunning(false);
                    setBreathRemaining(0);
                  }}
                >
                  Stop
                </button>
              ) : null}
            </div>
            {breathRunning ? (
              <p style={{ margin: '8px 0 0 0', fontWeight: 900 }}>
                {Math.max(0, breathRemaining)}s remaining
              </p>
            ) : null}
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: '0 0 12px 0', fontWeight: 900 }}>Preset controls</p>
            <div className="btnRow">
              <select value={speedPreset} onChange={(e) => setSpeedPreset(e.target.value)} style={{ padding: '10px', borderRadius: '12px', border: '1px solid #E0E0E0' }}>
                <option value="calm">Speed: Calm</option>
                <option value="fast">Speed: Fast</option>
              </select>
              <select value={interferencePreset} onChange={(e) => setInterferencePreset(e.target.value)} style={{ padding: '10px', borderRadius: '12px', border: '1px solid #E0E0E0' }}>
                <option value="low">Interference: Low</option>
                <option value="high">Interference: High</option>
              </select>
            </div>
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: '0 0 12px 0', fontWeight: 900 }}>Choose today's i3 Mindware game</p>
            <div style={{ display: 'grid', gap: '10px' }}>
              {GAMES.map((g) => (
                <button
                  key={g.id}
                  className="btn"
                  onClick={() => setSelectedGame(g.id)}
                  style={{
                    width: '100%',
                    textAlign: 'left',
                    background: selectedGame === g.id ? '#E8F4FF' : '#FFFFFF',
                    border: '1px solid ' + (selectedGame === g.id ? '#2764B7' : '#E0E0E0'),
                    color: '#111111'
                  }}
                >
                  <div style={{ fontWeight: 900 }}>{g.label}{g.id === 'classic' ? ' (Suggested start)' : ''}</div>
                  <div style={{ fontSize: '13px', marginTop: '6px', opacity: 0.85 }}>{g.note}</div>
                </button>
              ))}
            </div>
          </section>

          <section style={{ background: '#FFFFFF', border: '1px solid #E0E0E0', borderRadius: '16px', padding: '16px' }}>
            <p style={{ margin: 0, fontWeight: 900 }}>Today's plan: {planLabel}</p>
            <p style={{ marginTop: '8px' }}>Open i3 Mindware, run {selectedGameObj.label}, then return for wrap-up.</p>
            <div className="btnRow">
              <button className="btn btnPrimary" onClick={launchExternalGame}>Launch external app flow</button>
              <button className="btn btnSecondary" onClick={() => setScreen('results')}>I already ran it</button>
            </div>
          </section>
        </main>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>
