<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zone Coach - Mindware Lab</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind optional (kept for a few layout utilities only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Shared branding CSS (source of truth for colours, typography, buttons, cards, layout) -->
  <link rel="stylesheet" href="/iq-assessments/branding/brand.css?v=2" />

  <style>
    /* Keep minimal so brand.css stays in control */
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif);
      background: var(--bg, transparent);
    }
    input[type="range"] { accent-color: var(--deep, #2764B7); }

    /* Small helpers that won't fight brand.css */
    .center { display: flex; align-items: center; justify-content: center; }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .muted { color: rgba(0,0,0,0.65); }
    .strong { font-weight: 900; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // -----------------------------
    // Canonical keys (pipeline-ready)
    // -----------------------------
    const LS_KEYS = Object.freeze({
      ZONE_LAST: 'iqmw.zone.lastCheck',
      ZONE_HISTORY: 'iqmw.zone.history',
      CAPACITY_FROM_ZONE: 'iqmw.capacity.handoffFromZone'
    });

    // Optional cross-app fallback key (helps interoperability)
    const FALLBACK_CAPACITY_KEY = 'lastCapacitySession';

    // -----------------------------
    // Mode prototypes + classifier params
    // -----------------------------
    const PROTOTYPES = Object.freeze({
      SUB: Object.freeze({ E: 2, S: 3, F: 4, N: 5, O: 3, C: 3, R: 7 }),
      PSI: Object.freeze({ E: 5, S: 3, F: 8, N: 2, O: 4, C: 3, R: 2 }),
      ENT: Object.freeze({ E: 6, S: 6, F: 5, N: 8, O: 7, C: 8, R: 3 }),
      MIT: Object.freeze({ E: 6, S: 8, F: 8, N: 3, O: 7, C: 2, R: 9 }),
      DEP: Object.freeze({ E: 2, S: 7, F: 4, N: 7, O: 8, C: 6, R: 6 })
    });

    const WEIGHTS = Object.freeze({ E: 0.08, S: 0.10, F: 0.20, N: 0.18, O: 0.14, C: 0.10, R: 0.20 });
    const TAU = 6;

    const MODE_LABELS = Object.freeze({
      SUB: 'Subcritical',
      PSI: 'In the zone',
      ENT: 'Supercritical — scattered',
      MIT: 'Supercritical — rigid',
      DEP: 'Depleted overload'
    });

    // Map classifier output to simple gate used across ecosystem
    const toZoneGate = (primaryMode) => {
      if (primaryMode === 'PSI') return 'in_band';
      if (primaryMode === 'SUB') return 'cold';
      return 'hot';
    };

    // Suggest Type-1 capacity focus (shown as recommendation only in this free hook)
    const suggestedCapacityFromMode = (primaryMode) => {
      switch (primaryMode) {
        case 'SUB': return { primary: 'Hold', secondary: 'Update' };
        case 'PSI': return { primary: 'Update', secondary: 'Hold' };
        case 'ENT': return { primary: 'Stop', secondary: 'Shield' };
        case 'MIT': return { primary: 'Clear', secondary: 'Recover' };
        case 'DEP': return { primary: 'Recover', secondary: 'Stop' };
        default: return { primary: 'Recover', secondary: null };
      }
    };

    // -----------------------------
    // Breathing patterns
    // -----------------------------
    const makeRepeat = (n, seq) => Array.from({ length: n }, () => seq).flat();

    const BREATH_PATTERNS = Object.freeze({
      upshift: Object.freeze({
        id: 'upshift',
        name: 'Upshift',
        description:
          'Inhale-led breathing to gently raise engagement. Inhale through your nose. Exhale through your nose (or softly through your mouth if needed).',
        attentionCue: 'Anchor attention on the in-breath sensation. Return gently when distracted.',
        safety: 'If you feel dizzy or unwell, stop and return to normal breathing.',
        phases: [
          ...makeRepeat(10, [
            { label: 'Inhale', durationMs: 2000, kind: 'inhale' },
            { label: 'Exhale', durationMs: 2000, kind: 'exhale' }
          ]),
          ...makeRepeat(14, [
            { label: 'Inhale', durationMs: 3000, kind: 'inhale' },
            { label: 'Exhale', durationMs: 2000, kind: 'exhale' }
          ]),
          ...makeRepeat(10, [
            { label: 'Inhale', durationMs: 4000, kind: 'inhale' },
            { label: 'Exhale', durationMs: 3000, kind: 'exhale' }
          ])
        ]
      }),

      amplify: Object.freeze({
        id: 'amplify',
        name: 'Amplify',
        description:
          'Slow-paced breathing to stabilise. Inhale through your nose. Exhale through your nose (or softly through your mouth if needed).',
        attentionCue: 'Track the smooth rhythm. Thoughts are normal. Notice them and return to the breath.',
        safety: 'If you feel dizzy or unwell, stop and return to normal breathing.',
        phases: makeRepeat(18, [
          { label: 'Inhale', durationMs: 4000, kind: 'inhale' },
          { label: 'Exhale', durationMs: 6000, kind: 'exhale' }
        ])
      }),

      downshift: Object.freeze({
        id: 'downshift',
        name: 'Downshift',
        description:
          'Cyclic sighing to reduce arousal and overload. Take two small “sip” inhales through your nose, then a long sigh out through your mouth.',
        attentionCue: 'Count the pattern: sip, sip, long sigh. If your mind races, return to the count.',
        safety: 'If you feel dizzy or unwell, stop and return to normal breathing.',
        phases: makeRepeat(20, [
          { label: 'Inhale (1)', durationMs: 1000, kind: 'inhale' },
          { label: 'Inhale (2)', durationMs: 1000, kind: 'inhale' },
          { label: 'Sigh out', durationMs: 7000, kind: 'exhale' }
        ])
      })
    });

    const selectBreathingPattern = (primaryMode) => {
      if (primaryMode === 'SUB') return 'upshift';
      if (primaryMode === 'PSI') return 'amplify';
      return 'downshift';
    };

    // -----------------------------
    // Ratings items
    // -----------------------------
    const SLIDERS = Object.freeze([
      { key: 'E', label: 'Energy', desc: 'How much usable energy do you have right now to start and keep going?' },
      { key: 'S', label: 'Tension', desc: 'How tense or “on edge” do you feel in your body and mind?' },
      { key: 'F', label: 'Focus steadiness', desc: 'How easy is it to stay with one thing without forcing it?' },
      { key: 'N', label: 'Mental chatter', desc: 'How noisy is your mind with thoughts, worries, or distractions?' },
      { key: 'O', label: 'Mental load', desc: 'How overloaded do you feel by what you are juggling right now?' },
      { key: 'C', label: 'Plan switching', desc: 'Are you sticking to one plan, or do you keep changing direction and second-guessing?' },
      { key: 'R', label: 'Stuckness', desc: 'Do you feel flexible, or stuck in one way of doing things even if it is not working?' }
    ]);

    // -----------------------------
    // Podia signup
    // -----------------------------
    const PODIA_FORM_ACTION = 'https://iqmindware.podia.com/email_lists/959268/subscriptions';

    function PodiaSignup({ gate }) {
      return (
        <div className="card" style={{ boxShadow: 'none', marginTop: 12 }}>
          <div className="strong" style={{ fontSize: 14, color: 'rgba(0,0,0,0.85)' }}>
            Get on the waitlist for information to access to the upgraded app suite.
          </div>
          <p className="p" style={{ marginTop: 6 }}>
            Join the list to unlock the Capacity Training Coach + Tracking + the guided far-transfer loop app.
          </p>

          <form
            action={PODIA_FORM_ACTION}
            acceptCharset="UTF-8"
            method="post"
            className="stack"
            style={{ marginTop: 10 }}
          >
            {/* Optional tags for filtering/segmentation (may be ignored by Podia depending on embed type) */}
            <input type="hidden" name="tags[]" value="zone-coach" />
            <input type="hidden" name="tags[]" value={`gate-${gate}`} />

            <input
              className="p-3 rounded-lg border border-gray-200"
              type="text"
              name="name"
              placeholder="Name"
              autoComplete="name"
            />
            <input
              className="p-3 rounded-lg border border-gray-200"
              type="email"
              name="email"
              required
              placeholder="Email"
              autoComplete="email"
            />
            <input
              className="btn btnPrimary"
              type="submit"
              value="Join"
              style={{ width: '100%' }}
            />
          </form>

          <p className="p" style={{ marginTop: 8 }}>
            Your Zone check is saved locally in this browser.
          </p>
        </div>
      );
    }

    // -----------------------------
    // Classifier helpers
    // -----------------------------
    function computeDistance(ratings, prototype, weights) {
      let sum = 0;
      for (const k in prototype) {
        const diff = ratings[k] - prototype[k];
        sum += weights[k] * diff * diff;
      }
      return Math.sqrt(sum);
    }

    function classifyMode(ratings, externalDistractions) {
      const N_eff = externalDistractions ? Math.min(10, ratings.N + 2) : ratings.N;
      const adjusted = { ...ratings, N: N_eff };

      const scores = {};
      for (const mode in PROTOTYPES) {
        const d = computeDistance(adjusted, PROTOTYPES[mode], WEIGHTS);
        scores[mode] = Math.exp(-(d * d) / TAU);
      }

      const total = Object.values(scores).reduce((a, b) => a + b, 0);
      const probs = {};
      for (const mode in scores) probs[mode] = scores[mode] / total;

      const primaryMode = Object.keys(probs).reduce((a, b) => (probs[a] > probs[b] ? a : b));
      const top = probs[primaryMode];
      const confidence = top >= 0.60 ? 'High' : top >= 0.45 ? 'Medium' : 'Low';

      return { primaryMode, modeProbs: probs, confidence, N_eff };
    }

    // -----------------------------
    // Branded Frame
    // -----------------------------
    function Frame({ brand, chip, children }) {
      return (
        <div className="screen">
          <div className="topbar">
            <div className="brandleft">
              <div className="icon">
                <img
                  src={brand.logoSrc}
                  alt="Trident icon"
                  onError={(e) => { e.target.style.display = 'none'; }}
                />
              </div>
              <div>
                <p className="title">{brand.appName}</p>
                <p className="subtitle">{brand.subtitle}</p>
              </div>
            </div>
            <div className="chip">{chip}</div>
          </div>

          <div className="content">{children}</div>

          <div className="footer">
            <span>Mindware Lab • Trident</span>
            <span className="muted">Zone Coach</span>
          </div>
        </div>
      );
    }

    // -----------------------------
    // Breathing Coach component (single central window)
    // -----------------------------
    function BreathingCoach({ patternId, onComplete, brand }) {
      const pattern = BREATH_PATTERNS[patternId];

      const size = 270;
      const centre = size / 2;
      const minR = 56;
      const maxR = 100;
      const stroke = 10;

      const targetMs = 180000; // 3 minutes

      const [running, setRunning] = useState(false);
      const [elapsedMs, setElapsedMs] = useState(0);
      const [phaseLabel, setPhaseLabel] = useState('Ready');
      const [phaseKind, setPhaseKind] = useState('inhale');
      const [phaseProgress, setPhaseProgress] = useState(0);
      const [pingEnabled, setPingEnabled] = useState(true);
      const [audioReady, setAudioReady] = useState(false);

      const rafRef = useRef(null);
      const startRef = useRef(null);
      const pingerRef = useRef(null);
      const lastPhaseIndexRef = useRef(-1);

      const cycleMs = useMemo(
        () => pattern.phases.reduce((s, p) => s + p.durationMs, 0),
        [pattern]
      );

      const getPhaseAt = useCallback((tMs) => {
        const t = (tMs % cycleMs + cycleMs) % cycleMs;
        let acc = 0;

        for (let i = 0; i < pattern.phases.length; i++) {
          const p = pattern.phases[i];
          const next = acc + p.durationMs;

          if (t >= acc && t < next) {
            return {
              index: i,
              label: p.label,
              kind: p.kind,
              progress: p.durationMs > 0 ? (t - acc) / p.durationMs : 0
            };
          }
          acc = next;
        }

        const last = pattern.phases[pattern.phases.length - 1];
        return { index: pattern.phases.length - 1, label: last.label, kind: last.kind, progress: 1 };
      }, [cycleMs, pattern]);

      const ensurePinger = async () => {
        if (pingerRef.current) return true;
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return false;

          const ctx = new AudioCtx();
          if (ctx.state === 'suspended') await ctx.resume();

          pingerRef.current = {
            ctx,
            ping: (freqHz = 440) => {
              const t0 = ctx.currentTime;
              const osc = ctx.createOscillator();
              const g = ctx.createGain();

              osc.type = 'sine';
              osc.frequency.setValueAtTime(freqHz, t0);

              g.gain.setValueAtTime(0.0001, t0);
              g.gain.exponentialRampToValueAtTime(0.08, t0 + 0.01);
              g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);

              osc.connect(g);
              g.connect(ctx.destination);

              osc.start(t0);
              osc.stop(t0 + 0.11);
            }
          };

          return true;
        } catch {
          return false;
        }
      };

      const stop = () => {
        setRunning(false);
        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        rafRef.current = null;
      };

      const start = async () => {
        const ok = await ensurePinger();
        setAudioReady(ok);
        lastPhaseIndexRef.current = -1;
        startRef.current = performance.now();
        setElapsedMs(0);
        setRunning(true);
      };

      useEffect(() => {
        if (!running) return;

        const tick = () => {
          const now = performance.now();
          const elapsed = now - startRef.current;

          if (elapsed >= targetMs) {
            setElapsedMs(targetMs);
            stop();
            onComplete?.();
            return;
          }

          setElapsedMs(elapsed);

          const ph = getPhaseAt(elapsed);

          if (ph.index !== lastPhaseIndexRef.current) {
            if (pingEnabled && pingerRef.current && audioReady) {
              pingerRef.current.ping(ph.kind === 'inhale' ? 440 : 660);
            }
            lastPhaseIndexRef.current = ph.index;
          }

          setPhaseLabel(ph.label);
          setPhaseKind(ph.kind);
          setPhaseProgress(ph.progress);

          rafRef.current = requestAnimationFrame(tick);
        };

        rafRef.current = requestAnimationFrame(tick);
        return () => {
          if (rafRef.current) cancelAnimationFrame(rafRef.current);
        };
      }, [running, targetMs, getPhaseAt, pingEnabled, audioReady]);

      const displayRadius =
        minR + (maxR - minR) * (phaseKind === 'inhale' ? phaseProgress : 1 - phaseProgress);

      const overallProgress = Math.min(1, elapsedMs / targetMs);
      const remainingMs = Math.max(0, targetMs - elapsedMs);
      const mm = Math.floor(remainingMs / 60000);
      const ss = Math.floor((remainingMs % 60000) / 1000);

      const ringR = (maxR + 18);
      const ringC = 2 * Math.PI * ringR;
      const ringFill = ringC * overallProgress;
      const ringRest = ringC - ringFill;

      return (
        <Frame brand={brand} chip="Reset">
          <div className="card" style={{ maxWidth: 720, margin: '0 auto' }}>
            {/* Text ABOVE the circle */}
            <div className="stack">
              <div>
                <div className="h1" style={{ marginBottom: 6 }}>{pattern.name}</div>
                <p className="p">{pattern.description}</p>

                <div className="row" style={{ marginTop: 10, justifyContent: 'space-between' }}>
                  <div className="muted">
                    <span className="strong" style={{ color: 'var(--deep, #2764B7)' }}>Time remaining:</span>{' '}
                    <span className="strong">{mm}:{String(ss).padStart(2, '0')}</span>
                  </div>
                  <div className="muted">
                    <span className="strong" style={{ color: 'rgba(0,0,0,0.80)' }}>Cue:</span>{' '}
                    <span>{pattern.attentionCue}</span>
                  </div>
                </div>
              </div>

              {/* Circle CENTRE */}
              <div className="center" style={{ marginTop: 6 }}>
                <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} aria-label="Breathing guide">
                  <circle cx={centre} cy={centre} r={maxR} fill="none" stroke="rgba(0,0,0,0.12)" strokeWidth={stroke} />
                  <circle cx={centre} cy={centre} r={ringR} fill="none" stroke="rgba(0,0,0,0.10)" strokeWidth={6} />
                  <circle
                    cx={centre}
                    cy={centre}
                    r={ringR}
                    fill="none"
                    stroke="var(--deep, #2764B7)"
                    strokeOpacity="0.55"
                    strokeWidth={6}
                    strokeLinecap="round"
                    strokeDasharray={`${ringFill} ${ringRest}`}
                    transform={`rotate(-90 ${centre} ${centre})`}
                  />
                  <circle
                    cx={centre}
                    cy={centre}
                    r={displayRadius}
                    fill="none"
                    stroke="var(--deep, #2764B7)"
                    strokeOpacity="0.95"
                    strokeWidth={stroke}
                  />
                  <text x={centre} y={centre} textAnchor="middle" fontSize="20" fontWeight="900" fill="rgba(0,0,0,0.85)">
                    {phaseLabel}
                  </text>
                </svg>
              </div>

              {/* Controls BELOW the circle */}
              <div className="stack">
                <label style={{ display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer' }}>
                  <input
                    type="checkbox"
                    checked={pingEnabled}
                    onChange={(e) => setPingEnabled(e.target.checked)}
                    aria-label="Enable pings"
                  />
                  <span className="p" style={{ margin: 0, fontWeight: 900, color: 'rgba(0,0,0,0.80)' }}>
                    Ping at high/low points
                  </span>
                </label>

                {!audioReady && pingEnabled && (
                  <div className="p" style={{ marginTop: 0 }}>
                    Audio pings may be unavailable in this browser until interaction is allowed.
                  </div>
                )}

                <div className="card" style={{ background: 'rgba(204,255,102,0.16)', border: '1px solid rgba(0,0,0,0.06)', boxShadow: 'none' }}>
                  <div className="strong" style={{ color: 'rgba(0,0,0,0.85)', fontSize: 13 }}>Safety</div>
                  <div className="p" style={{ marginTop: 6 }}>{pattern.safety}</div>
                </div>

                <div className="btnRow">
                  {!running ? (
                    <button onClick={start} className="btn btnPrimary" style={{ flex: '1 1 220px' }}>
                      Start 3-minute reset
                    </button>
                  ) : (
                    <button onClick={stop} className="btn btnSecondary" style={{ flex: '1 1 220px' }}>
                      Stop
                    </button>
                  )}

                  <button
                    onClick={() => { stop(); onComplete?.(); }}
                    className="btn btnSecondary"
                    style={{ flex: '1 1 220px' }}
                  >
                    I’m done
                  </button>
                </div>
              </div>
            </div>
          </div>
        </Frame>
      );
    }

    // -----------------------------
    // ZoneCoach app (BRANDED)
    // -----------------------------
    function ZoneCoach() {
      const [showSplash, setShowSplash] = useState(true);
      const [step, setStep] = useState('ratings');

      const [ratings, setRatings] = useState({ E: 5, S: 5, F: 5, N: 5, O: 5, C: 5, R: 5 });
      const [externalDistractions, setExternalDistractions] = useState(false);

      const [classification, setClassification] = useState(null);
      const [breathPattern, setBreathPattern] = useState(null);
      const [postBreathReport, setPostBreathReport] = useState(null);

      const brand = useMemo(() => ({
        appName: 'Zone Coach',
        subtitle: 'Quick state check → mindful reset → start training',
        logoSrc: '/iq-assessments/branding/Trident-Icon.svg' // NOTE: no trailing slash
      }), []);

      const safeJsonParse = (s, fallback) => {
        try { return JSON.parse(s); } catch { return fallback; }
      };

      const writeZoneTelemetry = (zoneTelemetry, zoneHandoffSlim) => {
        try {
          const history = safeJsonParse(localStorage.getItem(LS_KEYS.ZONE_HISTORY) || '[]', []);
          history.push(zoneTelemetry);
          while (history.length > 30) history.shift();
          localStorage.setItem(LS_KEYS.ZONE_HISTORY, JSON.stringify(history));

          localStorage.setItem(LS_KEYS.ZONE_LAST, JSON.stringify(zoneTelemetry));

          // Slim handoff (saved, but the free hook does not link out to the coach)
          localStorage.setItem(LS_KEYS.CAPACITY_FROM_ZONE, JSON.stringify(zoneHandoffSlim));

          // Cross-app fallback handoff
          const fallback = {
            schemaVersion: 'mw_handoff_v1',
            timestamp: zoneTelemetry.timestamp,
            zone: zoneHandoffSlim.gate.zone, // cold | in_band | hot
            recommendation: zoneHandoffSlim.gate.recommendation, // proceed | light
            capacityFocus: zoneTelemetry.suggest?.capacityFocus || null,
            rigourBudget: zoneTelemetry.suggest?.rigourBudget || null,
            timeboxMins: zoneTelemetry.suggest?.timeboxMins || null
          };
          localStorage.setItem(FALLBACK_CAPACITY_KEY, JSON.stringify(fallback));
        } catch (e) {
          console.error('Storage error:', e);
        }
      };

      const handleRatingsSubmit = () => {
        const result = classifyMode(ratings, externalDistractions);
        const pattern = selectBreathingPattern(result.primaryMode);
        setClassification(result);
        setBreathPattern(pattern);
        setStep('results');
      };

      const handleStartBreathing = () => setStep('breathing');
      const handleBreathingComplete = () => setStep('postBreath');

      const handlePostBreathSubmit = (report) => {
        setPostBreathReport(report);

        const zoneGate = toZoneGate(classification.primaryMode);
        const preInBand = classification.primaryMode === 'PSI';
        const postInBand = report === 'Ψ-band';
        const proceedNormal = postInBand || preInBand;

        const derived = {
          N_eff: classification.N_eff,
          pressure: (ratings.S + ratings.O) / 2,
          interference: (ratings.N + ratings.C) / 2,
          load: (ratings.O + ratings.C + ratings.R) / 3,
          stability: (ratings.F + (10 - ratings.R)) / 2
        };

        const suggestedCapacity = suggestedCapacityFromMode(classification.primaryMode);

        const zoneTelemetry = {
          schemaVersion: 'zone_v1',
          timestamp: new Date().toISOString(),
          ratings,
          externalDistractions,
          derived,
          classifier: {
            primaryMode: classification.primaryMode,
            label: MODE_LABELS[classification.primaryMode],
            modeProbs: classification.modeProbs,
            confidence: classification.confidence
          },
          breathing: {
            patternId: breathPattern,
            patternName: BREATH_PATTERNS[breathPattern].name,
            completed: true,
            postBreathSelfReport: report
          },
          gate: {
            zone: zoneGate, // cold|in_band|hot
            preInBand,
            postInBand,
            recommendation: proceedNormal ? 'proceed' : 'light'
          },
          suggest: {
            rigourBudget: zoneGate === 'in_band' ? 'medium' : 'low',
            timeboxMins: zoneGate === 'in_band' ? 10 : 8,
            capacityFocus: suggestedCapacity
          }
        };

        const zoneHandoffSlim = {
          schemaVersion: 'zone_to_capacity_v1',
          timestamp: zoneTelemetry.timestamp,
          gate: {
            zone: zoneTelemetry.gate.zone,
            preInBand: zoneTelemetry.gate.preInBand,
            postInBand: zoneTelemetry.gate.postInBand,
            recommendation: zoneTelemetry.gate.recommendation
          },
          suggest: zoneTelemetry.suggest
        };

        writeZoneTelemetry(zoneTelemetry, zoneHandoffSlim);
        setStep('complete');
      };

      const startNewCheck = () => {
        setStep('ratings');
        setPostBreathReport(null);
        setClassification(null);
        setBreathPattern(null);
      };

      // Splash
      if (showSplash) {
        return (
          <Frame brand={brand} chip="Start">
            <div className="card" style={{ maxWidth: 560, margin: '0 auto', textAlign: 'center' }}>
              <div className="center" style={{ marginBottom: 12 }}>
                <div className="icon" style={{ width: 68, height: 68, borderRadius: 18 }}>
                  <img
                    src={brand.logoSrc}
                    alt="Trident icon"
                    onError={(e) => { e.target.style.display = 'none'; }}
                  />
                </div>
              </div>

              <div className="h1" style={{ fontSize: 26, marginBottom: 8 }}>{brand.appName}</div>
              <p className="p" style={{ fontSize: 14 }}>{brand.subtitle}</p>

              <div className="btnRow" style={{ justifyContent: 'center' }}>
                <button className="btn btnPrimary" style={{ width: 'min(360px, 100%)' }} onClick={() => setShowSplash(false)}>
                  Continue
                </button>
              </div>

              <p className="p" style={{ marginTop: 10 }}>Mindware Lab • Trident</p>
            </div>
          </Frame>
        );
      }

      // Breathing step (single central window)
      if (step === 'breathing') {
        return (
          <BreathingCoach
            patternId={breathPattern}
            onComplete={handleBreathingComplete}
            brand={brand}
          />
        );
      }

      // Main flow
      return (
        <Frame
          brand={brand}
          chip={step === 'ratings' ? 'Check' : step === 'results' ? 'Result' : step === 'postBreath' ? 'Report' : 'Next'}
        >
          <div className="card" style={{ maxWidth: 820, margin: '0 auto' }}>

            {step === 'ratings' && (
              <>
                <div className="h1">Zone check</div>
                <p className="p">Rate how you feel right now (0 = not at all, 10 = extremely).</p>

                <div style={{ marginTop: 10 }}>
                  {SLIDERS.map(s => (
                    <div key={s.key} className="card" style={{ boxShadow: 'none', marginTop: 12 }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', gap: 10 }}>
                        <div className="strong" style={{ fontSize: 14, color: 'rgba(0,0,0,0.85)' }}>{s.label}</div>
                        <div className="strong" style={{ color: 'var(--deep, #2764B7)' }}>{ratings[s.key]}</div>
                      </div>
                      <p className="p" style={{ marginTop: 6 }}>{s.desc}</p>

                      <input
                        type="range"
                        min="0"
                        max="10"
                        value={ratings[s.key]}
                        onChange={(e) => setRatings({ ...ratings, [s.key]: parseInt(e.target.value, 10) })}
                        style={{ width: '100%', marginTop: 8 }}
                        aria-label={s.label}
                      />
                    </div>
                  ))}
                </div>

                <div className="card" style={{ boxShadow: 'none', marginTop: 12 }}>
                  <label style={{ display: 'flex', alignItems: 'flex-start', gap: 10, cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={externalDistractions}
                      onChange={(e) => setExternalDistractions(e.target.checked)}
                      style={{ marginTop: 2 }}
                      aria-label="External distractions"
                    />
                    <span className="p" style={{ margin: 0, color: 'rgba(0,0,0,0.80)', fontWeight: 800 }}>
                      Notifications, noise, people, or interruptions are affecting me right now
                    </span>
                  </label>
                </div>

                <div className="btnRow">
                  <button onClick={handleRatingsSubmit} className="btn btnPrimary" style={{ width: '100%' }}>
                    Analyse my state
                  </button>
                </div>
              </>
            )}

            {step === 'results' && classification && (
              <>
                <div className="h1">Your current state</div>

                <div className="card" style={{
                  boxShadow: 'none',
                  background: 'rgba(34,170,255,0.08)',
                  border: '1px solid rgba(39,100,183,0.18)',
                  marginTop: 12
                }}>
                  <div className="strong" style={{ fontSize: 18, color: 'rgba(0,0,0,0.90)' }}>
                    {MODE_LABELS[classification.primaryMode]}
                  </div>
                  <p className="p" style={{ marginTop: 6 }}>
                    Confidence: <span className="strong" style={{ color: 'var(--deep, #2764B7)' }}>{classification.confidence}</span>
                  </p>
                </div>

                <div className="card" style={{ boxShadow: 'none', marginTop: 12 }}>
                  <div className="strong" style={{ fontSize: 14, color: 'rgba(0,0,0,0.85)' }}>Recommended reset</div>
                  <div className="strong" style={{ fontSize: 16, color: 'var(--deep, #2764B7)', marginTop: 6 }}>
                    {BREATH_PATTERNS[breathPattern].name}
                  </div>
                  <p className="p" style={{ marginTop: 6 }}>{BREATH_PATTERNS[breathPattern].description}</p>
                  <p className="p" style={{ marginTop: 8 }}>
                    Do the 3-minute reset, then we will decide the best training intensity.
                  </p>

                  <div className="btnRow">
                    <button onClick={handleStartBreathing} className="btn btnPrimary" style={{ width: '100%' }}>
                      Start 3-minute reset
                    </button>
                    <button onClick={startNewCheck} className="btn btnSecondary" style={{ width: '100%' }}>
                      Back
                    </button>
                  </div>
                </div>
              </>
            )}

            {step === 'postBreath' && (
              <>
                <div className="h1">How do you feel now?</div>
                <p className="p">Quick check after your breathing reset.</p>

                <div style={{ display: 'flex', flexDirection: 'column', gap: 10, marginTop: 12 }}>
                  {[
                    { label: 'Flat / low drive', value: 'Subcritical' },
                    { label: 'In the zone', value: 'Ψ-band' },
                    { label: 'Overloaded & scattered', value: 'Supercritical – explore' },
                    { label: 'Over-tight & stuck', value: 'Supercritical – rigid control' },
                    { label: 'Not sure', value: 'Not sure' }
                  ].map(opt => (
                    <button
                      key={opt.value}
                      onClick={() => handlePostBreathSubmit(opt.value)}
                      className="btn btnSecondary"
                      style={{ textAlign: 'left', width: '100%' }}
                    >
                      {opt.label}
                    </button>
                  ))}
                </div>
              </>
            )}

            {step === 'complete' && classification && (
              <>
                <div className="h1">Reset complete ✓</div>

                <div className="card" style={{
                  boxShadow: 'none',
                  background: 'rgba(34,170,255,0.08)',
                  border: '1px solid rgba(39,100,183,0.18)',
                  marginTop: 12
                }}>
                  <div className="strong" style={{ fontSize: 16, color: 'rgba(0,0,0,0.90)' }}>
                    Post-breath: <span style={{ color: 'var(--deep, #2764B7)' }}>{postBreathReport}</span>
                  </div>
                </div>

                {(() => {
                  const zoneGate = toZoneGate(classification.primaryMode);
                  const preInBand = classification.primaryMode === 'PSI';
                  const postInBand = postBreathReport === 'Ψ-band';
                  const proceedNormal = preInBand || postInBand;

                  const suggestion = suggestedCapacityFromMode(classification.primaryMode);

                  return (
                    <div className="card" style={{ boxShadow: 'none', marginTop: 12 }}>
                      <div className="strong" style={{ fontSize: 14, color: 'rgba(0,0,0,0.85)' }}>
                        Next step
                      </div>

                      <p className="p" style={{ marginTop: 8 }}>
                        Cognitive Zone in Training: <span className="strong" style={{ color: 'rgba(0,0,0,0.90)' }}>{zoneGate.replace('_', ' ')}</span>
                        <span className="muted"> • Suggested focus for dual n-back training: </span>
                        <span className="strong" style={{ color: 'rgba(0,0,0,0.90)' }}>{suggestion.primary}</span>
                        {suggestion.secondary ? <span className="muted"> then </span> : null}
                        {suggestion.secondary ? <span className="strong" style={{ color: 'rgba(0,0,0,0.90)' }}>{suggestion.secondary}</span> : null}
                      </p>

                      {proceedNormal ? (
                        <p className="p" style={{ marginTop: 8, fontWeight: 800 }}>
                          You are good to train with the dual n-back. To stay updated on the upgraded and powerful app package to be released next month - scientifically designed for effective far-transfer - sign up below.
                        </p>
                      ) : (
                        <p className="p" style={{ marginTop: 8, fontWeight: 800 }}>
                          Light day recommended. Keep it short and stabilising today. Request waitlist access below for the updated app suite for augmenting IQ.
                        </p>
                      )}

                      <PodiaSignup gate={zoneGate} />

                      <div className="btnRow">
                        <button onClick={startNewCheck} className="btn btnSecondary" style={{ width: '100%' }}>
                          Start new check
                        </button>
                      </div>
                    </div>
                  );
                })()}
              </>
            )}

          </div>
        </Frame>
      );
    }

    // React 18 root
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ZoneCoach />);
  </script>
</body>
</html>
