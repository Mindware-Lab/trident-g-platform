<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Switcher Training App</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const SessionSwitcher = () => {
      // Branding
      const brand = {
        appName: 'Capacity Training Coach',
        subtitle: 'Adaptive cognitive training based on your current state',
        accent: '#2764B7',
        logoSrc: './assets/Trident-Logo.svg'
      };

      // ---- Per-day session counter (FIX: persist across reloads) ----
      const todayKey = () => `sessionsCompleted_${new Date().toISOString().slice(0,10)}`;

      const loadSessionsCompletedToday = () => {
        try {
          const v = parseInt(localStorage.getItem(todayKey()) || '0', 10);
          return Number.isFinite(v) ? v : 0;
        } catch {
          return 0;
        }
      };

      const bumpSessionsCompletedToday = () => {
        const next = loadSessionsCompletedToday() + 1;
        try { localStorage.setItem(todayKey(), String(next)); } catch {}
        setSessionsCompletedToday(next);
        return next;
      };

      // Splash screen state
      const [showSplash, setShowSplash] = useState(true);

      // NEW: Add state for Zone Check data
      const [zoneCheckData, setZoneCheckData] = useState(null);

      // NEW: Unit progression state
      const [userProgress, setUserProgress] = useState(() => {
        try {
          const stored = localStorage.getItem('trainingProgress');
          return stored ? JSON.parse(stored) : {
            anchorSessionsCompleted: 0,
            currentUnit: 1,
            unitsCompleted: [],
            swapSessionsCompleted: 0,
            lastSessionDate: null,
            programStartDate: new Date().toISOString(),
            programCompleted: false,
            programCompletionDate: null
          };
        } catch {
          return {
            anchorSessionsCompleted: 0,
            currentUnit: 1,
            unitsCompleted: [],
            swapSessionsCompleted: 0,
            lastSessionDate: null,
            programStartDate: new Date().toISOString(),
            programCompleted: false,
            programCompletionDate: null
          };
        }
      });

      // REPLACE THESE WITH YOUR ACTUAL URLS
      const DNB_URL = "PASTE_YOUR_DNB_APP_URL_HERE";
      const GPT_URL = "PASTE_YOUR_GPT_APP_URL_HERE";

      // Swap game URLs
      const SWAP_URLS = {
        classic: "PASTE_CLASSIC_SWAP_URL",
        logic_gated: "PASTE_LOGIC_GATED_URL",
        emotional: "PASTE_EMOTIONAL_URL"
      };

      // Unit URLs - replace with actual URLs or use pattern
      const OPERATOR_URLS = {
        1: "https://mindware-lab.github.io/iq-assessments/units/unit-1",
        2: "https://mindware-lab.github.io/iq-assessments/units/unit-2",
        3: "https://mindware-lab.github.io/iq-assessments/units/unit-3",
        4: "https://mindware-lab.github.io/iq-assessments/units/unit-4",
        5: "https://mindware-lab.github.io/iq-assessments/units/unit-5",
        6: "https://mindware-lab.github.io/iq-assessments/units/unit-6",
        7: "https://mindware-lab.github.io/iq-assessments/units/unit-7",
        8: "https://mindware-lab.github.io/iq-assessments/units/unit-8",
        9: "https://mindware-lab.github.io/iq-assessments/units/unit-9",
        10: "https://mindware-lab.github.io/iq-assessments/units/unit-10",
        11: "https://mindware-lab.github.io/iq-assessments/units/unit-11",
        12: "https://mindware-lab.github.io/iq-assessments/units/unit-12",
        13: "https://mindware-lab.github.io/iq-assessments/units/unit-13",
        14: "https://mindware-lab.github.io/iq-assessments/units/unit-14",
        15: "https://mindware-lab.github.io/iq-assessments/units/unit-15",
        16: "https://mindware-lab.github.io/iq-assessments/units/unit-16",
        17: "https://mindware-lab.github.io/iq-assessments/units/unit-17",
        18: "https://mindware-lab.github.io/iq-assessments/units/unit-18",
        19: "https://mindware-lab.github.io/iq-assessments/units/unit-19",
        20: "https://mindware-lab.github.io/iq-assessments/units/unit-20"
      };

      // Helper function to get unit URL
      const getUnitUrl = (unitNumber) => {
        return OPERATOR_URLS[unitNumber] || `https://mindware-lab.github.io/iq-assessments/units/unit-${unitNumber}`;
      };

      // Unit metadata - titles and info for all 20 units
      const UNIT_METADATA = {
        1: { title: "Shift the story + test it", category: "Mental Attitude", time: "â‰¤10 min" },
        2: { title: "Fast OODA loop", category: "Strategic Planning", time: "â‰¤10 min" },
        3: { title: "Turn it into a checklist", category: "Strategic Planning", time: "â‰¤10 min" },
        4: { title: "Update your belief (don't get stuck)", category: "Mental Attitude", time: "â‰¤10 min" },
        5: { title: "Spot the pattern", category: "Comprehension", time: "â‰¤10 min" },
        6: { title: "Test your assumptions", category: "Argumentation", time: "â‰¤10 min" },
        7: { title: "Consider the opposite", category: "Argumentation", time: "â‰¤10 min" },
        8: { title: "Base rate + adjustment", category: "Decision Making", time: "â‰¤10 min" },
        9: { title: "Pre-mortem analysis", category: "Strategic Planning", time: "â‰¤10 min" },
        10: { title: "Steelman the argument", category: "Argumentation", time: "â‰¤10 min" },
        11: { title: "Double-crux dialogue", category: "Argumentation", time: "â‰¤10 min" },
        12: { title: "Seek disconfirming evidence", category: "Comprehension", time: "â‰¤10 min" },
        13: { title: "Separate signal from noise", category: "Comprehension", time: "â‰¤10 min" },
        14: { title: "Opportunity cost thinking", category: "Decision Making", time: "â‰¤10 min" },
        15: { title: "Expected value calculation", category: "Decision Making", time: "â‰¤10 min" },
        16: { title: "Zoom in, zoom out", category: "Strategic Planning", time: "â‰¤10 min" },
        17: { title: "Second-order effects", category: "Strategic Action", time: "â‰¤10 min" },
        18: { title: "Reversible vs irreversible decisions", category: "Decision Making", time: "â‰¤10 min" },
        19: { title: "Multiplier thinking", category: "Strategic Action", time: "â‰¤10 min" },
        20: { title: "Strategic optionality", category: "Strategic Action", time: "â‰¤10 min" }
      };

      // Helper to get latest Zone Check telemetry
      const getLatestZoneTelemetry = () => {
        try {
          const stored = localStorage.getItem('zoneCheckTelemetry');
          return stored ? JSON.parse(stored) : null;
        } catch {
          return null;
        }
      };

      const [screen, setScreen] = useState('postBreath');
      const [postBreathState, setPostBreathState] = useState(null);
      const [trained3, setTrained3] = useState(null);
      const [progress, setProgress] = useState(null);
      const [routine, setRoutine] = useState(null);
      const [robustness, setRobustness] = useState(null);
      const [click, setClick] = useState(null);
      const [clickNote, setClickNote] = useState('');
      const [showClickInput, setShowClickInput] = useState(false);
      const [deploy, setDeploy] = useState(null);
      const [breaksFirst, setBreaksFirst] = useState(null);
      const [swapChoice, setSwapChoice] = useState(null);
      const [swapStrategy, setSwapStrategy] = useState(null);
      const [recommendation, setRecommendation] = useState(null);
      const [sessionFeel, setSessionFeel] = useState(null);
      const [carryOver, setCarryOver] = useState(null);
      const [spikeGap, setSpikeGap] = useState(null);
      const [bridgeObs, setBridgeObs] = useState('');
      const [bridgeMove, setBridgeMove] = useState('');
      const [selectedChange, setSelectedChange] = useState('none');
      const [sessionsCompletedToday, setSessionsCompletedToday] = useState(() => loadSessionsCompletedToday());

      // Save progress whenever it changes
      React.useEffect(() => {
        try {
          localStorage.setItem('trainingProgress', JSON.stringify(userProgress));
        } catch (error) {
          console.warn('Failed to save progress:', error);
        }
      }, [userProgress]);

      // FIX: choose the correct game URL (Anchor vs Swap)
      const getGameUrl = (isSwap, finalGame) => {
        if (!isSwap) return DNB_URL;
        return SWAP_URLS[finalGame] || DNB_URL;
      };

      // NEW: Read Zone Check telemetry on component load
      React.useEffect(() => {
        // Check if user just completed a unit
        const lastCompletion = localStorage.getItem('lastUnitCompletion');
        if (lastCompletion) {
          const data = JSON.parse(lastCompletion);

          // Re-load zone telemetry to get dose info
          const z = getLatestZoneTelemetry();

          // Update progress
          setUserProgress(prev => {
            const newProgress = { ...prev };

            if (!newProgress.unitsCompleted.includes(data.unitNumber)) {
              newProgress.unitsCompleted.push(data.unitNumber);
            }

            // For anchor sessions, advance unit
            // Try to read session type from various sources
            let isAnchorSession = false;

            // Source 1: Unit completion data might include it (passed from unit app)
            if (data.sessionType) {
              isAnchorSession = data.sessionType === 'anchor_noncat';
            }
            // Source 2: Check sessionStorage (set before navigation)
            else if (sessionStorage.getItem('currentSessionType')) {
              isAnchorSession = sessionStorage.getItem('currentSessionType') === 'anchor_noncat';
              sessionStorage.removeItem('currentSessionType'); // Clean up
              sessionStorage.removeItem('currentSessionTimestamp');
            }
            // Source 3: Fallback - check if unit number matches current unit
            else {
              // If unit completed is the current unit, it was likely an anchor session
              // If it's a different unit, it was likely a swap session with manual selection
              isAnchorSession = data.unitNumber === newProgress.currentUnit;
            }

            if (isAnchorSession) {
              newProgress.anchorSessionsCompleted += 1;
              newProgress.currentUnit = Math.min(newProgress.currentUnit + 1, 20);
            } else {
              newProgress.swapSessionsCompleted += 1;
            }

            newProgress.lastSessionDate = new Date().toISOString();

            if (newProgress.anchorSessionsCompleted >= 20) {
              newProgress.programCompleted = true;
              newProgress.programCompletionDate = new Date().toISOString();
            }

            return newProgress;
          });

          // Clear the completion flag
          localStorage.removeItem('lastUnitCompletion');

          // FIX: persisted per-day counter
          const totalSessions = z?.dose?.sessions ?? 1;
          const newSessionsCompleted = bumpSessionsCompletedToday();

          // FIX: avoid blank recommendation screen; restore last plan if present, else go to eligibility
          let restored = null;
          try {
            restored = JSON.parse(sessionStorage.getItem('lastPlanState') || 'null');
          } catch {}

          if (newSessionsCompleted < totalSessions) {
            alert(`Unit ${data.unitNumber} complete! Starting session ${newSessionsCompleted + 1} of ${totalSessions}...`);
            if (restored?.recommendation) {
              try {
                setPostBreathState(restored.postBreathState || postBreathState);
                setTrained3(restored.trained3 || trained3);
                setProgress(restored.progress || progress);
                setRoutine(restored.routine || routine);
                setRobustness(restored.robustness || robustness);
                setClick(restored.click || click);
                setDeploy(restored.deploy || deploy);
                setSpikeGap(restored.spikeGap || spikeGap);
                setBreaksFirst(restored.breaksFirst || breaksFirst);
                setSelectedChange(restored.selectedChange || 'none');
                setSwapChoice(restored.swapChoice || null);
                setSwapStrategy(restored.swapStrategy || null);
                setRecommendation(restored.recommendation);
                setScreen('recommendation');
              } catch {
                setScreen('eligibility');
              }
            } else {
              setScreen('eligibility');
            }
          } else {
            alert(`Unit ${data.unitNumber} complete! All sessions done for today.`);
            setScreen('afterTraining');
          }

          return; // Stop here if we just processed a completion
        }

        // Otherwise, check for Zone Check data
        let data = null;
        let fromLocalStorage = false;

        // STRATEGY 1: Try localStorage first (best UX, full data available)
        try {
          const stored = localStorage.getItem('zoneCheckTelemetry');
          if (stored) {
            data = JSON.parse(stored);
            fromLocalStorage = true;
            console.log('Zone Check data loaded from localStorage (same device)');
          }
        } catch (error) {
          console.warn('localStorage read failed:', error);
        }

        // STRATEGY 2: Fallback to URL params (cross-device or localStorage blocked)
        if (!data) {
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('mode')) {
            data = {
              postBreathMode: urlParams.get('mode'),
              dose: {
                level: urlParams.get('dose'),
                sessions: parseInt(urlParams.get('sessions')),
                blocks: parseInt(urlParams.get('blocks'))
              }
            };
            console.log('Zone Check data loaded from URL params (cross-device or fallback)');
          }
        }

        // FIX: Validate telemetry is from today (treat missing localDate as stale when from localStorage)
        if (data) {
          const todayLocalDate = new Date().toISOString().slice(0, 10);
          if (fromLocalStorage && (!data.localDate || data.localDate !== todayLocalDate)) {
            console.warn('Zone Check telemetry is stale or missing localDate - treating as missing');
            data = null;
          } else if (data.localDate && data.localDate !== todayLocalDate) {
            console.warn('Zone Check telemetry is stale (not from today) - treating as missing');
            data = null;
          }
        }

        // Process data if found
        if (data) {
          setZoneCheckData(data);

          // Map post-breath mode to internal state format
          const modeToStateMap = {
            'Subcritical (flat/demotivated)': 'subcritical',
            'Î¨-band (in the zone)': 'psi',
            'Supercritical: rigid control': 'super_rigid',
            'Supercritical: scattered explore': 'super_scattered',
            'Mixed / unclear': 'mixed'
          };

          const mappedState = modeToStateMap[data.postBreathMode] || 'mixed';
          setPostBreathState(mappedState);

          // Check dose recommendation
          if (data.dose && data.dose.sessions === 0) {
            // Red dose - block training
            console.log('Red dose detected - blocking training');
            setScreen('blocked');
            return;
          }

          // Green or Amber dose - skip post-breath screen, go directly to eligibility
          console.log(`${data.dose?.level || 'unknown'} dose detected - ${data.dose?.sessions || 0} session(s) allowed`);
          setScreen('eligibility');
        } else {
          console.log('No Zone Check data found - user can start fresh with post-breath screen');
        }
      }, []); // Empty dependency array = run once on component mount

      const settingsFor = (planType, changeSelection = 'none') => {
        switch (planType) {
          case 'anchor_light':
          case 'anchor_stabilise':
          case 'anchor_consolidate':
          case 'swap_variant':
            return { speed: false, interference: false, handSwitch: false };
          case 'anchor_build':
            if (changeSelection === 'speed') return { speed: true, interference: false, handSwitch: false };
            if (changeSelection === 'interference') return { speed: false, interference: true, handSwitch: false };
            return { speed: false, interference: false, handSwitch: false };
          case 'anchor_probe':
            if (changeSelection === 'interference') return { speed: false, interference: true, handSwitch: false };
            if (changeSelection === 'hand') return { speed: false, interference: false, handSwitch: true };
            if (changeSelection === 'speed') return { speed: true, interference: false, handSwitch: false };
            return { speed: false, interference: false, handSwitch: false };
          default:
            return { speed: false, interference: false, handSwitch: false };
        }
      };

      const getTrainingFocus = (settings) => {
        if (settings.interference) return "Interference control";
        if (settings.speed) return "Speeded updating";
        if (settings.handSwitch) return "Rule remapping";
        return "Clean stability";
      };

      const goToRecommendation = (r) => {
        setRecommendation(r);
        setSelectedChange('none');
        setSwapChoice(null);
        setSwapStrategy(null);
        setScreen('recommendation');
      };

      const buildOperatorUrl = (unitNumber, ctx) => {
        const baseUrl = getUnitUrl(unitNumber);

        try {
          const url = new URL(baseUrl);

          // Pass game context
          url.searchParams.set('unit', unitNumber);
          url.searchParams.set('focus', ctx.focus);
          url.searchParams.set('plan', ctx.plan);
          url.searchParams.set('game', ctx.game);

          // Pass settings
          url.searchParams.set('speed', ctx.settings.speed ? '1' : '0');
          url.searchParams.set('interference', ctx.settings.interference ? '1' : '0');
          url.searchParams.set('hand', ctx.settings.handSwitch ? '1' : '0');

          // Pass state
          if (ctx.zone) url.searchParams.set('zone', ctx.zone);
          if (ctx.strategy) url.searchParams.set('strategy', ctx.strategy);

          // Pass spike-capture bridge data (no double encoding)
          url.searchParams.set('obs', ctx.obs || '');
          url.searchParams.set('move', ctx.move || '');

          // Pass progression data
          url.searchParams.set('sessionsCompleted', ctx.sessionsCompleted || 0);
          url.searchParams.set('totalSessions', ctx.totalSessions || 1);

          // FIX: Add return URL (NO double-encoding; URLSearchParams will encode safely)
          url.searchParams.set('return', window.location.href);

          return url.toString();
        } catch (error) {
          console.error('Error building URL:', error);
          return baseUrl;
        }
      };

      const calcRec = () => {
        const zone = postBreathState;
        if (trained3 === 'no') {
          return {
            planType: zone === 'psi' ? 'anchor_light' : 'anchor_stabilise',
            game: 'anchor_noncat',
            wheelAdvances: true
          };
        }

        const stalled =
          (progress === 'plateau' || progress === 'unsure') &&
          click === 'no' &&
          spikeGap === 'long' &&
          robustness !== 'improved';

        const unstableOrFlat =
          zone === 'subcritical' || zone === 'super_rigid' || zone === 'super_scattered';

        if (unstableOrFlat && stalled) {
          return { planType: 'swap_variant', game: 'classic', wheelAdvances: false };
        }

        if (zone !== 'psi') {
          return { planType: 'anchor_stabilise', game: 'anchor_noncat', wheelAdvances: true };
        }

        if (click === 'yes') return { planType: 'anchor_consolidate', game: 'anchor_noncat', wheelAdvances: true };

        if ((deploy === 'yes' || deploy === 'somewhat') && robustness !== 'worse') {
          return { planType: 'anchor_consolidate', game: 'anchor_noncat', wheelAdvances: true };
        }

        if (routine === 'very' && (progress === 'unsure' || progress === 'plateau') && robustness !== 'improved') {
          let game = 'classic';
          if (breaksFirst === 'rule_mapping') game = 'logic_gated';
          else if (breaksFirst === 'emotional') game = 'emotional';
          return { planType: 'swap_variant', game, wheelAdvances: false };
        }

        if (progress === 'plateau' && (robustness === 'same' || robustness === 'worse')) {
          return { planType: routine === 'somewhat' || routine === 'very' ? 'anchor_probe' : 'anchor_build', game: 'anchor_noncat', wheelAdvances: true };
        }

        return { planType: 'anchor_build', game: 'anchor_noncat', wheelAdvances: true };
      };

      const names = {
        anchor_light: "Anchor session (light)",
        anchor_stabilise: "Anchor session (wheel step)",
        anchor_build: "Anchor session (wheel step)",
        anchor_probe: "Anchor session (probe)",
        anchor_consolidate: "Anchor session (consolidate)",
        swap_variant: "Swap session (variant today)"
      };

      const recipes = {
        anchor_light: "Keep it simple today: play the Anchor with default settings. Keep the wrapper stable. Aim for a clean run.",
        anchor_stabilise: "Keep it clean and stable. No speed shifts, no interference, no switching.",
        anchor_build: "Anchor only. Keep it mostly stable. Add ONE mild change today: either 1 slightly faster block OR 1 slightly higher-interference block. Don't stack changes.",
        anchor_probe: "Probe day: if you feel stable, select Interference ON below and add 1â€“2 interference blocks. Otherwise keep it clean and stable.",
        anchor_consolidate: "Anchor only. Stable wrapper. Minimal interference. No speed shifts. No switching. Repeat yesterday's approach and keep it clean.",
        swap_variant: "Play one Swap game today instead of the Anchor. Keep settings stable. Tomorrow, return to the Anchor for a rebound test."
      };

      const swapGames = [
        { id: 'classic', title: 'Classic (tempo / dual-load)', bestWhen: 'Best when you fall behind, start guessing, or one stream drops out.', strategies: ['comprehension', 'strategic_action'] },
        { id: 'logic_gated', title: 'Logic-gated (rule discipline)', bestWhen: 'Best when rule/mapping changes break you, or switching causes confusion.', strategies: ['argumentation'] },
        { id: 'emotional', title: 'Emotional (salience control)', bestWhen: 'Best when distraction, rumination, or affect hijacks attention.', strategies: ['mental_attitude', 'decision_making'] }
      ];

      // Render nothing initially while React is setting up
      if (!screen) return null;

      // SPLASH SCREEN
      if (showSplash) {
        return (
          <div style={{
            minHeight: '100vh',
            background: '#E0E0E0',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '24px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
          }}>
            <div style={{
              width: 'min(560px, 100%)',
              background: '#FFFFFF',
              borderRadius: '12px',
              padding: '28px 24px',
              boxShadow: '0 10px 15px -3px rgba(0,0,0,0.12)',
              textAlign: 'center'
            }}>
              <img
                src={brand.logoSrc}
                alt="Trident logo"
                style={{
                  width: '96px',
                  height: '96px',
                  margin: '0 auto 16px',
                  objectFit: 'contain'
                }}
                onError={(e) => { e.target.style.display = 'none'; }}
              />
              <div style={{
                fontSize: '28px',
                fontWeight: '900',
                color: '#333333',
                marginBottom: '8px'
              }}>
                {brand.appName}
              </div>
              <div style={{
                fontSize: '14px',
                fontWeight: '600',
                color: '#6D6D6D',
                marginBottom: '20px',
                lineHeight: '1.4'
              }}>
                {brand.subtitle}
              </div>
              <button
                onClick={() => setShowSplash(false)}
                style={{
                  width: '100%',
                  padding: '12px 14px',
                  borderRadius: '12px',
                  border: 'none',
                  background: brand.accent,
                  color: '#FFFFFF',
                  fontSize: '16px',
                  fontWeight: '900',
                  cursor: 'pointer'
                }}
                onMouseEnter={(e) => e.currentTarget.style.filter = 'brightness(0.9)'}
                onMouseLeave={(e) => e.currentTarget.style.filter = 'none'}
              >
                Continue
              </button>
              <div style={{
                marginTop: '16px',
                fontSize: '12px',
                color: '#6D6D6D'
              }}>
                Mindware Lab â€¢ Trident
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Blocked (Red dose from Zone Check)
      if (screen === 'blocked') {
        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <div className="text-center mb-6">
                  <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>ðŸ›‘</div>
                  <h1 className="text-3xl font-bold mb-4" style={{ color: '#333333' }}>
                    Training Not Recommended Today
                  </h1>
                  <p className="mb-4" style={{ color: '#6D6D6D' }}>
                    Your Zone Check indicated you're too far out of band for quality training.
                  </p>
                </div>

                {zoneCheckData && zoneCheckData.dose && (
                  <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#FFE8E8', border: '2px solid #FF6B6B' }}>
                    <p className="font-semibold mb-2" style={{ color: '#333333' }}>Your State:</p>
                    <p className="mb-3" style={{ color: '#333333' }}>
                      Post-breathing: <strong>{zoneCheckData.postBreathMode}</strong>
                    </p>
                    <p className="font-semibold mb-2" style={{ color: '#333333' }}>Recommendation:</p>
                    <p className="text-sm" style={{ color: '#333333' }}>
                      {zoneCheckData.dose.recommendation || "Rest and try again when you're in a better state."}
                    </p>
                  </div>
                )}

                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#F5F5F5' }}>
                  <p className="font-semibold mb-2" style={{ color: '#333333' }}>Recovery Options:</p>
                  <ul className="text-sm space-y-2" style={{ color: '#333333' }}>
                    <li>â€¢ Rest and try again tomorrow</li>
                    <li>â€¢ Repeat breathing practice in 1-2 hours</li>
                    <li>â€¢ Light physical movement (walk, stretch)</li>
                    <li>â€¢ Address underlying stressors if possible</li>
                  </ul>
                </div>

                <button
                  onClick={() => {
                    alert('Rest is important for cognitive training. Close this tab and try again tomorrow when you are in a better state.');
                  }}
                  className="w-full py-3 px-6 rounded-lg font-semibold transition-all shadow-md"
                  style={{ backgroundColor: '#2764B7', color: '#FFFFFF' }}>
                  Close This Tab
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Post-Breath
      if (screen === 'postBreath') {
        const states = [
          { id: 'subcritical', label: 'Subcritical (flat/demotivated)', color: '#22AAFF' },
          { id: 'psi', label: 'Î¨-band (in the zone)', color: '#CCFF66' },
          { id: 'super_rigid', label: 'Supercritical: rigid control', color: '#FFB020' },
          { id: 'super_scattered', label: 'Supercritical: scattered explore', color: '#B07CFF' },
          { id: 'mixed', label: 'Mixed / unclear', color: '#6D6D6D' }
        ];

        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-2" style={{ color: '#333333' }}>How do you feel now?</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>You've completed 3 minutes of breathing. Where are you at now?</p>
                <div className="space-y-3 mb-6">
                  {states.map(s => (
                    <button key={s.id} onClick={() => setPostBreathState(s.id)} className="w-full p-4 rounded-lg border-2 font-semibold text-left transition-all"
                      style={{ borderColor: postBreathState === s.id ? s.color : '#E0E0E0', backgroundColor: postBreathState === s.id ? `${s.color}20` : '#FFFFFF', color: '#333333' }}>
                      {s.label}
                    </button>
                  ))}
                </div>
                <p className="text-sm mb-6" style={{ color: '#6D6D6D' }}>If you're not sure, choose 'Mixed / unclear'.</p>
                <button onClick={() => postBreathState && setScreen('eligibility')} disabled={!postBreathState} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: postBreathState ? '#2764B7' : '#E0E0E0', color: postBreathState ? '#FFFFFF' : '#6D6D6D', cursor: postBreathState ? 'pointer' : 'not-allowed' }}>
                  Continue
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Eligibility
      if (screen === 'eligibility') {
        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-2" style={{ color: '#333333' }}>Quick check</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>Have you done at least 3 training sessions before today?</p>
                <div className="space-y-3 mb-6">
                  {['yes', 'no'].map(opt => (
                    <button key={opt} onClick={() => setTrained3(opt)} className="w-full p-4 rounded-lg border-2 font-semibold transition-all capitalize"
                      style={{ borderColor: trained3 === opt ? '#2764B7' : '#E0E0E0', backgroundColor: trained3 === opt ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                      {opt}
                    </button>
                  ))}
                </div>
                <p className="text-sm mb-6" style={{ color: '#6D6D6D' }}>If this is your first few sessions, we keep it simple.</p>
                <button onClick={() => {
                  if (!trained3) return;
                  if (trained3 === 'no') {
                    goToRecommendation(calcRec());
                  } else {
                    setScreen('lastSessions');
                  }
                }}
                  disabled={!trained3} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: trained3 ? '#2764B7' : '#E0E0E0', color: trained3 ? '#FFFFFF' : '#6D6D6D', cursor: trained3 ? 'pointer' : 'not-allowed' }}>
                  Continue
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Last Sessions
      if (screen === 'lastSessions') {
        const canContinue = progress && routine && robustness && click && deploy && spikeGap;
        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-2" style={{ color: '#333333' }}>Last 2â€“3 sessions</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>Answer quickly based on your last couple of sessions.</p>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did you make progress?</p>
                  <div className="space-y-2">
                    {[{id: 'clear', label: 'Yes, clear progress'}, {id: 'unsure', label: 'A bit / unsure'}, {id: 'plateau', label: 'No, plateau'}].map(o => (
                      <button key={o.id} onClick={() => setProgress(o.id)} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{ borderColor: progress === o.id ? '#2764B7' : '#E0E0E0', backgroundColor: progress === o.id ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did it feel routine and automatic?</p>
                  <div className="space-y-2">
                    {[{id: 'not', label: 'Not really'}, {id: 'somewhat', label: 'Somewhat'}, {id: 'very', label: 'Very routine'}].map(o => (
                      <button key={o.id} onClick={() => setRoutine(o.id)} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{ borderColor: routine === o.id ? '#2764B7' : '#E0E0E0', backgroundColor: routine === o.id ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did your performance hold up when you changed settings in the Anchor game?</p>
                  <p className="text-sm mb-3" style={{ color: '#6D6D6D' }}>Changes = speed, interference, or hand/response mapping.</p>
                  <div className="space-y-2">
                    {[
                      {id: 'improved', label: 'Improved'},
                      {id: 'same', label: 'Same as usual'},
                      {id: 'worse', label: 'Worse / fragile'},
                      {id: 'not_tried', label: "Didn't try changes (kept it stable)"}
                    ].map(o => (
                      <button key={o.id} onClick={() => setRobustness(o.id)} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{ borderColor: robustness === o.id ? '#2764B7' : '#E0E0E0', backgroundColor: robustness === o.id ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did anything 'click' recently?</p>
                  <div className="space-y-2 mb-3">
                    <button onClick={() => { setClick('yes'); setShowClickInput(true); }} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                      style={{ borderColor: click === 'yes' ? '#2764B7' : '#E0E0E0', backgroundColor: click === 'yes' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                      Yes
                    </button>
                    <button onClick={() => { setClick('no'); setShowClickInput(false); setClickNote(''); }} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                      style={{ borderColor: click === 'no' ? '#2764B7' : '#E0E0E0', backgroundColor: click === 'no' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                      No
                    </button>
                  </div>
                  {showClickInput && (
                    <div className="p-4 rounded-lg" style={{ backgroundColor: '#F5F5F5' }}>
                      <label className="block text-sm font-semibold mb-2" style={{ color: '#333333' }}>What changed? (one line)</label>
                      <p className="text-xs mb-2" style={{ color: '#6D6D6D' }}>Keep it simple. What did you do differently?</p>
                      <input type="text" value={clickNote} onChange={(e) => setClickNote(e.target.value)} placeholder="E.g., 'I slowed down', 'I stopped guessing'..." className="w-full p-3 rounded border-2 mb-3" style={{ borderColor: '#E0E0E0' }} />
                      <div className="flex gap-2">
                        <button onClick={() => setShowClickInput(false)} className="flex-1 py-2 px-4 rounded-lg font-semibold" style={{ backgroundColor: '#2764B7', color: '#FFFFFF' }}>Save and continue</button>
                        <button onClick={() => { setClickNote(''); setShowClickInput(false); }} className="flex-1 py-2 px-4 rounded-lg font-semibold border-2" style={{ borderColor: '#E0E0E0', color: '#333333', backgroundColor: '#FFFFFF' }}>Skip</button>
                      </div>
                    </div>
                  )}
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did your strategy help outside the game since your last session?</p>
                  <div className="space-y-2">
                    {[{id: 'yes', label: 'Yes'}, {id: 'somewhat', label: 'Somewhat'}, {id: 'no', label: 'No'}, {id: 'didnt_try', label: "Didn't try"}].map(o => (
                      <button key={o.id} onClick={() => setDeploy(o.id)} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{ borderColor: deploy === o.id ? '#2764B7' : '#E0E0E0', backgroundColor: deploy === o.id ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>
                    When was your last step-change session?
                  </p>
                  <p className="text-sm mb-3" style={{ color: '#6D6D6D' }}>
                    A step-change = a clear jump, a 'click', or holding up much better under changes.
                  </p>
                  <div className="space-y-2">
                    {[
                      { id: 'recent', label: 'In the last 1â€“2 sessions' },
                      { id: 'mid', label: 'About 3â€“4 sessions ago' },
                      { id: 'long', label: "Not recently / can't remember" }
                    ].map(o => (
                      <button
                        key={o.id}
                        onClick={() => setSpikeGap(o.id)}
                        className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{
                          borderColor: spikeGap === o.id ? '#2764B7' : '#E0E0E0',
                          backgroundColor: spikeGap === o.id ? '#E8F4FF' : '#FFFFFF',
                          color: '#333333'
                        }}
                      >
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>

                <button onClick={() => {
                  if (!canContinue) return;
                  const r = calcRec();
                  if (r.planType === 'swap_variant' && postBreathState === 'psi' && !breaksFirst) {
                    setBreaksFirst(null);
                    setSwapChoice(null);
                    setSwapStrategy(null);
                    setSelectedChange('none');
                    setScreen('breakdown');
                  } else {
                    goToRecommendation(r);
                  }
                }}
                  disabled={!canContinue} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: canContinue ? '#2764B7' : '#E0E0E0', color: canContinue ? '#FFFFFF' : '#6D6D6D', cursor: canContinue ? 'pointer' : 'not-allowed' }}>
                  Get my plan
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Breakdown
      if (screen === 'breakdown') {
        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-2" style={{ color: '#333333' }}>One more thing</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>When things break down, what breaks first?</p>
                <div className="space-y-3 mb-6">
                  {[{id: 'tempo', label: 'Keeping up (tempo / speed)'}, {id: 'rule_mapping', label: 'Rules or mapping (I get confused)'}, {id: 'emotional', label: 'Emotional pull (rumination / distraction)'}, {id: 'not_sure', label: 'Not sure'}].map(o => (
                    <button key={o.id} onClick={() => setBreaksFirst(o.id)} className="w-full p-4 rounded-lg border-2 font-semibold text-left transition-all"
                      style={{ borderColor: breaksFirst === o.id ? '#2764B7' : '#E0E0E0', backgroundColor: breaksFirst === o.id ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                      {o.label}
                    </button>
                  ))}
                </div>
                <button onClick={() => {
                  if (!breaksFirst) return;
                  goToRecommendation(calcRec());
                }} disabled={!breaksFirst} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: breaksFirst ? '#2764B7' : '#E0E0E0', color: breaksFirst ? '#FFFFFF' : '#6D6D6D', cursor: breaksFirst ? 'pointer' : 'not-allowed' }}>
                  Show my plan
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Recommendation
      if (screen === 'recommendation' && recommendation) {
        const isSwap = recommendation.planType === 'swap_variant';
        const finalGame = swapChoice || recommendation.game;
        const settings = settingsFor(recommendation.planType, selectedChange);
        const trainingFocus = getTrainingFocus(settings);

        const gameUrl = getGameUrl(isSwap, finalGame);

        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-3xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-4" style={{ color: '#333333' }}>Today's plan</h1>

                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#E8F4FF', border: '2px solid #2764B7' }}>
                  <p className="font-semibold" style={{ color: '#333333' }}>Keep this page open. When you finish training, come back here for a 20-second wrap-up.</p>
                </div>

                <h2 className="text-2xl font-bold mb-6" style={{ color: '#2764B7' }}>{names[recommendation.planType]}</h2>

                <div className="mb-6 p-4 rounded-lg" style={{ backgroundColor: '#F5F5F5' }}>
                  <p className="font-semibold" style={{ color: '#333333' }}>
                    {recommendation.wheelAdvances
                      ? "This counts towards your 20 Anchor sessions and advances the wheel."
                      : "This does NOT advance the wheel. Next session returns to the Anchor and repeats the same wheel unit."}
                  </p>
                </div>

                <div className="mb-6">
                  <h3 className="font-bold mb-2" style={{ color: '#333333' }}>What to play</h3>
                  <p className="mb-2" style={{ color: '#333333' }}>
                    {isSwap ? "Play today: Choose a Swap game below (recommended highlighted)." : "Play today: Non-categorical dual n-back (Anchor)."}
                  </p>
                  <p className="text-sm" style={{ color: '#6D6D6D' }}>Keep settings stable today. The point is a clean probe, not maximum difficulty.</p>
                </div>

                <div className="mb-6 p-4 rounded-lg" style={{ backgroundColor: '#F5FFE6', border: '1px solid #CCFF66' }}>
                  <p style={{ color: '#333333' }}>{recipes[recommendation.planType]}</p>
                  {isSwap && <p className="mt-2 font-semibold" style={{ color: '#333333' }}>Swap sessions are usually just one day. Tomorrow's Anchor session is where we check if it helped.</p>}
                </div>

                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#F5F5F5' }}>
                  <h3 className="font-bold mb-3" style={{ color: '#333333' }}>Today's settings</h3>
                  <p className="text-sm mb-3" style={{ color: '#6D6D6D' }}>Change at most ONE thing today. Clean runs beat "hard" runs.</p>
                  <ul className="space-y-2" style={{ color: '#333333' }}>
                    <li><b>Speed (double pace):</b> {settings.speed ? 'ON' : 'OFF'}</li>
                    <li><b>Interference / lures:</b> {settings.interference ? 'ON' : 'OFF'}</li>
                    <li><b>Hand/response switching:</b> {settings.handSwitch ? 'ON' : 'OFF'}</li>
                  </ul>
                </div>

                {(recommendation.planType === 'anchor_build' || recommendation.planType === 'anchor_probe') && (
                  <div className="mb-6 p-4 rounded-lg" style={{ backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                    <p className="font-semibold mb-3" style={{ color: '#333333' }}>Choose today's ONE change:</p>
                    <div className="space-y-2">
                      <button onClick={() => setSelectedChange('none')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{ borderColor: selectedChange === 'none' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'none' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                        No change (clean stability)
                      </button>
                      {recommendation.planType === 'anchor_build' && (
                        <>
                          <button onClick={() => setSelectedChange('interference')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                            style={{ borderColor: selectedChange === 'interference' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'interference' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                            Interference ON (recommended)
                          </button>
                          <button onClick={() => setSelectedChange('speed')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                            style={{ borderColor: selectedChange === 'speed' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'speed' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                            Speed ON
                          </button>
                        </>
                      )}
                      {recommendation.planType === 'anchor_probe' && (
                        <>
                          <button onClick={() => setSelectedChange('interference')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                            style={{ borderColor: selectedChange === 'interference' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'interference' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                            Interference ON (recommended)
                          </button>
                          <button onClick={() => setSelectedChange('hand')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                            style={{ borderColor: selectedChange === 'hand' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'hand' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                            Hand/response switching ON
                          </button>
                          <button onClick={() => setSelectedChange('speed')} className="w-full p-3 rounded-lg border-2 text-left transition-all"
                            style={{ borderColor: selectedChange === 'speed' ? '#2764B7' : '#E0E0E0', backgroundColor: selectedChange === 'speed' ? '#E8F4FF' : '#FFFFFF', color: '#333333' }}>
                            Speed ON
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                )}

                {isSwap && (
                  <div className="mb-6">
                    <p className="font-semibold mb-4" style={{ color: '#333333' }}>
                      Recommended: {recommendation.game === 'classic' ? 'Classic' : recommendation.game === 'logic_gated' ? 'Logic-gated' : 'Emotional'}
                    </p>
                    <p className="text-sm mb-4" style={{ color: '#6D6D6D' }}>You can follow the recommendation, or choose a different swap game below.</p>
                    <div className="space-y-3">
                      {swapGames.map(g => (
                        <div key={g.id} onClick={() => { setSwapChoice(g.id); setSwapStrategy(null); }}
                          className="p-4 rounded-lg border-2 cursor-pointer transition-all"
                          style={{ borderColor: finalGame === g.id ? '#2764B7' : '#E0E0E0', backgroundColor: finalGame === g.id ? '#E8F4FF' : '#FFFFFF' }}>
                          <p className="font-bold mb-1" style={{ color: '#333333' }}>
                            {g.title} {recommendation.game === g.id && !swapChoice && <span style={{ color: '#2764B7' }}>(Recommended)</span>}
                          </p>
                          <p className="text-sm mb-2" style={{ color: '#6D6D6D' }}>{g.bestWhen}</p>
                          <div className="flex gap-2 mt-2">
                            {g.strategies.map(s => (
                              <button key={s} onClick={(e) => { e.stopPropagation(); setSwapChoice(g.id); setSwapStrategy(s); }}
                                className="px-3 py-1 rounded text-sm border-2 transition-all"
                                style={{
                                  borderColor: swapStrategy === s && finalGame === g.id ? '#2764B7' : '#E0E0E0',
                                  backgroundColor: swapStrategy === s && finalGame === g.id ? '#2764B7' : '#FFFFFF',
                                  color: swapStrategy === s && finalGame === g.id ? '#FFFFFF' : '#333333'
                                }}>
                                {s.replace(/_/g, ' ')}
                              </button>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <button onClick={() => window.open(gameUrl, '_blank', 'noopener,noreferrer')}
                  className="w-full py-3 px-6 rounded-lg font-semibold transition-all shadow-md mb-3"
                  style={{ backgroundColor: '#2764B7', color: '#FFFFFF' }}>
                  Open today's game (new tab)
                </button>

                <button onClick={() => {
                  const finalGameValue = swapChoice || recommendation.game;
                  const finalSettings = settingsFor(recommendation.planType, selectedChange);
                  setRecommendation({ ...recommendation, game: finalGameValue, settings: finalSettings });
                  setScreen('afterTraining');
                }} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: '#FFFFFF', color: '#2764B7', border: '2px solid #2764B7' }}>
                  I've finished the game â€” do the 20-second bridge
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: After Training
      if (screen === 'afterTraining') {
        const settings = recommendation?.settings || { speed: false, interference: false, handSwitch: false };
        const trainingFocus = getTrainingFocus(settings);
        const unitsToComplete = zoneCheckData?.dose?.sessions || 1;
        const currentUnitToComplete = userProgress.currentUnit;
        const isAnchorSession = recommendation?.game === 'anchor_noncat';
        const unitInfo = UNIT_METADATA[currentUnitToComplete] || { title: "Mindware Practice", category: "Mindware", time: "â‰¤10 min" };

        const copyBridgeToClipboard = () => {
          const bridgeText = `Today I trained: ${trainingFocus}. In the game it looked like: ${bridgeObs}. In the next task I will use it by: ${bridgeMove}.`;
          navigator.clipboard.writeText(bridgeText).then(() => {
            alert('Bridge copied to clipboard!');
          }).catch(err => {
            console.error('Failed to copy:', err);
          });
        };

        const bridgeComplete = bridgeObs.trim() && bridgeMove.trim();

        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-2xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-2" style={{ color: '#333333' }}>Spike-capture bridge</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>20 seconds to lock in what you just trained.</p>

                {/* Visual indicator for multi-session flow */}
                {sessionsCompletedToday > 0 && (
                  <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#E8F4FF', border: '2px solid #2764B7' }}>
                    <p className="font-semibold" style={{ color: '#333333' }}>
                      âœ“ Session {sessionsCompletedToday} Complete!
                    </p>
                    <p className="text-sm" style={{ color: '#6D6D6D' }}>
                      Starting session {Math.min(sessionsCompletedToday + 1, unitsToComplete)} of {unitsToComplete}
                    </p>
                  </div>
                )}

                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#E8F4FF', border: '2px solid #2764B7' }}>
                  <p className="font-semibold" style={{ color: '#333333' }}>
                    Today I trained: <span style={{ color: '#2764B7' }}>{trainingFocus}</span>
                  </p>

                  <label className="block text-sm font-semibold mt-4 mb-2" style={{ color: '#333333' }}>
                    In the game it looked likeâ€¦ (one observation)
                  </label>
                  <input type="text" value={bridgeObs} onChange={(e) => setBridgeObs(e.target.value)}
                    className="w-full p-3 rounded border-2" style={{ borderColor: '#E0E0E0' }}
                    placeholder="E.g., 'I stopped guessing and waited for certainty'..." />

                  <label className="block text-sm font-semibold mt-4 mb-2" style={{ color: '#333333' }}>
                    In the next task I will use it byâ€¦ (one mindware move)
                  </label>
                  <input type="text" value={bridgeMove} onChange={(e) => setBridgeMove(e.target.value)}
                    className="w-full p-3 rounded border-2 mb-4" style={{ borderColor: '#E0E0E0' }}
                    placeholder="E.g., 'I'll write a 2-option trade-off table before deciding'..." />

                  <div className="flex gap-2">
                    <button onClick={copyBridgeToClipboard} disabled={!bridgeComplete}
                      className="flex-1 py-2 px-4 rounded-lg font-semibold"
                      style={{ backgroundColor: bridgeComplete ? '#22AAFF' : '#E0E0E0', color: '#FFFFFF', cursor: bridgeComplete ? 'pointer' : 'not-allowed' }}>
                      Copy bridge
                    </button>
                  </div>
                </div>

                {/* Unit Exercise Section */}
                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: isAnchorSession ? '#F5FFE6' : '#FFF3E0', border: `2px solid ${isAnchorSession ? '#CCFF66' : '#FFB020'}` }}>
                  <p className="font-semibold mb-2" style={{ color: '#333333' }}>
                    ðŸ“š Next: Mindware Practice
                  </p>
                  {isAnchorSession ? (
                    <>
                      <p className="text-sm mb-1" style={{ color: '#333333' }}>
                        Complete Unit {currentUnitToComplete}: "{unitInfo.title}"
                      </p>
                      <p className="text-sm mb-4" style={{ color: '#6D6D6D' }}>
                        {unitInfo.category} â€¢ {unitInfo.time} â€¢ Session {Math.min(sessionsCompletedToday + 1, unitsToComplete)} of {unitsToComplete}
                      </p>
                    </>
                  ) : (
                    <>
                      <p className="text-sm mb-3" style={{ color: '#333333' }}>
                        Choose a mindware unit to practise (manual selection)
                      </p>
                      <p className="text-sm mb-4" style={{ color: '#6D6D6D' }}>
                        Swap sessions don't auto-advance the wheel
                      </p>
                    </>
                  )}

                  <button
                    onClick={() => {
                      if (!bridgeComplete) {
                        alert('Please complete the spike-capture bridge first');
                        return;
                      }

                      // Store session type in sessionStorage before navigating
                      sessionStorage.setItem('currentSessionType', recommendation.game);
                      sessionStorage.setItem('currentSessionTimestamp', Date.now().toString());

                      // Build context to pass to unit
                      const unitContext = {
                        focus: trainingFocus,
                        plan: recommendation.planType,
                        game: recommendation.game,
                        settings: settings,
                        zone: postBreathState,
                        strategy: swapStrategy || '',
                        obs: bridgeObs,
                        move: bridgeMove,
                        sessionsCompleted: sessionsCompletedToday,
                        totalSessions: unitsToComplete
                      };

                      // FIX: Persist the last plan state so we can restore it after unit completion
                      try {
                        sessionStorage.setItem('lastPlanState', JSON.stringify({
                          postBreathState,
                          trained3,
                          progress,
                          routine,
                          robustness,
                          click,
                          deploy,
                          spikeGap,
                          breaksFirst,
                          selectedChange,
                          swapChoice,
                          swapStrategy,
                          recommendation: { ...recommendation, settings }
                        }));
                      } catch {}

                      // For anchor: open current unit automatically
                      if (isAnchorSession) {
                        const unitUrl = buildOperatorUrl(currentUnitToComplete, unitContext);
                        window.location.href = unitUrl; // Navigate to unit app
                      } else {
                        // For swap: show unit wheel for manual selection
                        setScreen('unitWheel');
                      }
                    }}
                    disabled={!bridgeComplete}
                    className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                    style={{
                      backgroundColor: bridgeComplete ? '#2764B7' : '#E0E0E0',
                      color: bridgeComplete ? '#FFFFFF' : '#6D6D6D',
                      cursor: bridgeComplete ? 'pointer' : 'not-allowed'
                    }}>
                    {isAnchorSession
                      ? `Start Unit ${currentUnitToComplete}`
                      : "Choose Mindware Unit"}
                  </button>
                </div>

                {/* GPT Deployment Button */}
                <button onClick={() => window.open(GPT_URL, '_blank', 'noopener,noreferrer')}
                  disabled={!bridgeComplete} className="w-full py-2 px-4 rounded-lg font-semibold border-2 mb-6"
                  style={{
                    borderColor: bridgeComplete ? '#2764B7' : '#E0E0E0',
                    color: bridgeComplete ? '#2764B7' : '#6D6D6D',
                    backgroundColor: '#FFFFFF',
                    cursor: bridgeComplete ? 'pointer' : 'not-allowed'
                  }}>
                  Open real-world deployment (GPT)
                </button>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>How did today's session feel overall?</p>
                  <div className="space-y-2">
                    {[
                      { id: 'smooth', label: 'Smooth and productive' },
                      { id: 'ok', label: 'OK / mixed' },
                      { id: 'struggle', label: 'Struggled / off' }
                    ].map(opt => (
                      <button key={opt.id} onClick={() => setSessionFeel(opt.id)}
                        className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{
                          borderColor: sessionFeel === opt.id ? '#2764B7' : '#E0E0E0',
                          backgroundColor: sessionFeel === opt.id ? '#E8F4FF' : '#FFFFFF',
                          color: '#333333'
                        }}>
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <p className="font-semibold mb-3" style={{ color: '#333333' }}>Did the n-back session carry over into the strategy practice?</p>
                  <div className="space-y-2">
                    {[
                      { id: 'yes_clearer', label: 'Yes â€” clearer thinking' },
                      { id: 'yes_focus', label: 'Yes â€” better focus / steadier' },
                      { id: 'no_separate', label: 'No â€” it felt separate today' },
                      { id: 'no_practice', label: "I didn't do the strategy practice" }
                    ].map(opt => (
                      <button key={opt.id} onClick={() => setCarryOver(opt.id)}
                        className="w-full p-3 rounded-lg border-2 text-left transition-all"
                        style={{
                          borderColor: carryOver === opt.id ? '#2764B7' : '#E0E0E0',
                          backgroundColor: carryOver === opt.id ? '#E8F4FF' : '#FFFFFF',
                          color: '#333333'
                        }}>
                        {opt.label}
                      </button>
                    ))}
                  </div>
                  <p className="text-sm mt-2" style={{ color: '#6D6D6D' }}>
                    Carry over = you could apply the mindware more cleanly right after training.
                  </p>
                </div>

                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                  <p className="text-sm" style={{ color: '#333333' }}>
                    ðŸ’¡ Before your next session, try the same mindware strategy once in real life. Think about the situation you might apply it in now, and what might cue it for you.
                  </p>
                </div>

                {/* Progress Display */}
                <div className="p-4 rounded-lg mb-6" style={{ backgroundColor: '#F5F5F5' }}>
                  <p className="text-sm font-semibold mb-2" style={{ color: '#333333' }}>Your Progress:</p>
                  <p className="text-sm" style={{ color: '#333333' }}>
                    Anchor sessions: {userProgress.anchorSessionsCompleted} of 20 complete
                  </p>
                  <p className="text-sm" style={{ color: '#333333' }}>
                    Current unit: {userProgress.currentUnit} of 20
                  </p>
                  {userProgress.swapSessionsCompleted > 0 && (
                    <p className="text-sm" style={{ color: '#6D6D6D' }}>
                      Swap sessions: {userProgress.swapSessionsCompleted}
                    </p>
                  )}
                </div>

                <button onClick={() => {
                  // Reset state for next session (do NOT wipe today's persisted counter)
                  setScreen('postBreath');
                  setRecommendation(null);
                  setPostBreathState(null);
                  setTrained3(null);
                  setProgress(null);
                  setRoutine(null);
                  setRobustness(null);
                  setClick(null);
                  setClickNote('');
                  setDeploy(null);
                  setBreaksFirst(null);
                  setSwapChoice(null);
                  setSwapStrategy(null);
                  setSessionFeel(null);
                  setCarryOver(null);
                  setSpikeGap(null);
                  setBridgeObs('');
                  setBridgeMove('');
                  setSelectedChange('none');
                  setSessionsCompletedToday(loadSessionsCompletedToday());
                }} className="w-full py-3 px-6 rounded-lg font-semibold transition-all"
                  style={{ backgroundColor: '#2764B7', color: '#FFFFFF' }}>
                  Done
                </button>
              </div>
            </div>
          </div>
        );
      }

      // SCREEN: Unit Wheel (for swap sessions - manual unit selection)
      if (screen === 'unitWheel') {
        const settings = recommendation?.settings || { speed: false, interference: false, handSwitch: false };
        const trainingFocus = getTrainingFocus(settings);

        return (
          <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#E0E0E0' }}>
            <div className="max-w-3xl mx-auto">
              <div className="rounded-lg shadow-lg p-6 md:p-8" style={{ backgroundColor: '#FFFFFF' }}>
                <h1 className="text-3xl font-bold mb-4" style={{ color: '#333333' }}>Choose Your Mindware Unit</h1>
                <p className="mb-6" style={{ color: '#6D6D6D' }}>
                  Since you did a swap game today, select which mindware unit you'd like to practise:
                </p>

                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                  {Array.from({length: 20}, (_, i) => i + 1).map(unit => {
                    const isCompleted = userProgress.unitsCompleted.includes(unit);
                    return (
                      <button
                        key={unit}
                        onClick={() => {
                          const unitContext = {
                            focus: trainingFocus,
                            plan: recommendation.planType,
                            game: recommendation.game,
                            settings: settings,
                            zone: postBreathState,
                            strategy: swapStrategy || '',
                            obs: bridgeObs,
                            move: bridgeMove,
                            sessionsCompleted: sessionsCompletedToday,
                            totalSessions: zoneCheckData?.dose?.sessions || 1
                          };

                          // Persist last plan state as well (helps restore after completion)
                          try {
                            sessionStorage.setItem('lastPlanState', JSON.stringify({
                              postBreathState,
                              trained3,
                              progress,
                              routine,
                              robustness,
                              click,
                              deploy,
                              spikeGap,
                              breaksFirst,
                              selectedChange,
                              swapChoice,
                              swapStrategy,
                              recommendation: { ...recommendation, settings }
                            }));
                          } catch {}

                          const unitUrl = buildOperatorUrl(unit, unitContext);
                          window.location.href = unitUrl;
                        }}
                        className="p-4 rounded-lg border-2 font-semibold transition-all"
                        style={{
                          borderColor: isCompleted ? '#CCFF66' : '#E0E0E0',
                          backgroundColor: isCompleted ? '#F5FFE6' : '#FFFFFF',
                          color: '#333333'
                        }}>
                        Unit {unit}
                        {isCompleted && <div className="text-xs mt-1" style={{ color: '#6D6D6D' }}>âœ“ Complete</div>}
                      </button>
                    );
                  })}
                </div>

                <button
                  onClick={() => setScreen('afterTraining')}
                  className="w-full py-3 px-6 rounded-lg font-semibold border-2 transition-all"
                  style={{ borderColor: '#2764B7', color: '#2764B7', backgroundColor: '#FFFFFF' }}>
                  Back
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    };

    // Render the app (FIX: React 18 createRoot)
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SessionSwitcher />);
  </script>
</body>
</html>
